(()=>{var X=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var g=(e,t,n)=>new Promise((a,o)=>{var d=l=>{try{s(n.next(l))}catch(c){o(c)}},i=l=>{try{s(n.throw(l))}catch(c){o(c)}},s=l=>l.done?a(l.value):Promise.resolve(l.value).then(d,i);s((n=n.apply(e,t)).next())});var he=X(V=>{let u=[],M=[],H="",p=null,v="",A="setup",f=null,$=null,y="en",b=45,L="normal",Z="spotify",K=!1,I=!0,S=[],w=null;const R="beatify_last_player",J="beatify_game_settings",j=["media-players","playlists","game-settings","admin-actions"],r=window.BeatifyUtils||{};document.addEventListener("DOMContentLoaded",()=>g(V,null,function*(){var t,n,a,o,d,i;(yield r.waitForI18n())?(yield BeatifyI18n.init(),BeatifyI18n.initPageTranslations(),y=BeatifyI18n.getLanguage()):console.error("[Beatify] BeatifyI18n module failed to load - UI will use fallback text"),document.querySelectorAll(".chip[data-lang]").forEach(s=>{s.classList.toggle("chip--active",s.dataset.lang===y)}),(t=document.getElementById("start-game"))==null||t.addEventListener("click",de),(n=document.getElementById("print-qr"))==null||n.addEventListener("click",ge),(a=document.getElementById("rejoin-game"))==null||a.addEventListener("click",fe),(o=document.getElementById("end-game"))==null||o.addEventListener("click",P),(d=document.getElementById("end-game-lobby"))==null||d.addEventListener("click",P),(i=document.getElementById("end-game-existing"))==null||i.addEventListener("click",P),pe(),ue(),te(),ne(),ae(),yield ee()}));function ee(){return g(this,null,function*(){try{const e=yield fetch("/beatify/api/status");if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=yield e.json();H=t.playlist_docs_url||"",v=t.media_player_docs_url||"",K=t.has_music_assistant===!0;const n=document.getElementById("app-version");n&&t.version&&(n.textContent="v"+t.version),se(t.media_players),oe(t.playlists,t.playlist_dir),_(),t.active_game?ce(t.active_game):D()}catch(e){console.error("Failed to load status:",e);const t=document.getElementById("media-players-list");t&&(t.innerHTML='<span class="status-error">Failed to load status</span>')}})}function te(){var e,t;(e=document.getElementById("media-players-toggle"))==null||e.addEventListener("click",function(){const n=document.getElementById("media-players");n&&(n.classList.toggle("collapsed"),this.setAttribute("aria-expanded",!n.classList.contains("collapsed")))}),(t=document.getElementById("game-settings-toggle"))==null||t.addEventListener("click",function(){const n=document.getElementById("game-settings");n&&(n.classList.toggle("collapsed"),this.setAttribute("aria-expanded",!n.classList.contains("collapsed")))}),document.querySelectorAll(".lobby-container--compact .section-header-collapsible").forEach(function(n){n.addEventListener("click",function(){const a=n.closest(".section-collapsible");a&&(a.classList.toggle("collapsed"),n.setAttribute("aria-expanded",!a.classList.contains("collapsed")))})})}function ne(){var e;document.querySelectorAll(".chip[data-lang]").forEach(t=>{t.addEventListener("click",function(){const n=this.dataset.lang;document.querySelectorAll(".chip[data-lang]").forEach(a=>a.classList.remove("chip--active")),this.classList.add("chip--active"),y=n,window.BeatifyI18n&&BeatifyI18n.setLanguage(n),h(),B()})}),document.querySelectorAll(".chip[data-duration]").forEach(t=>{t.addEventListener("click",function(){const n=parseInt(this.dataset.duration,10);document.querySelectorAll(".chip[data-duration]").forEach(a=>a.classList.remove("chip--active")),this.classList.add("chip--active"),b=n,h(),B()})}),document.querySelectorAll(".chip[data-difficulty]").forEach(t=>{t.addEventListener("click",function(){const n=this.dataset.difficulty;document.querySelectorAll(".chip[data-difficulty]").forEach(a=>a.classList.remove("chip--active")),this.classList.add("chip--active"),L=n,h(),B()})}),(e=document.getElementById("artist-challenge-toggle"))==null||e.addEventListener("change",function(){I=this.checked,h(),B()})}function ae(){try{const e=localStorage.getItem(J);if(e){const t=JSON.parse(e);if(t.language&&(y=t.language,document.querySelectorAll(".chip[data-lang]").forEach(n=>{n.classList.toggle("chip--active",n.dataset.lang===t.language)}),window.BeatifyI18n&&BeatifyI18n.setLanguage(t.language)),t.duration&&(b=t.duration,document.querySelectorAll(".chip[data-duration]").forEach(n=>{n.classList.toggle("chip--active",parseInt(n.dataset.duration,10)===t.duration)})),t.difficulty&&(L=t.difficulty,document.querySelectorAll(".chip[data-difficulty]").forEach(n=>{n.classList.toggle("chip--active",n.dataset.difficulty===t.difficulty)})),typeof t.artistChallenge=="boolean"){I=t.artistChallenge;const n=document.getElementById("artist-challenge-toggle");n&&(n.checked=t.artistChallenge)}}}catch(e){console.warn("Failed to load saved settings:",e)}h()}function B(){try{const e={language:y,duration:b,difficulty:L,artistChallenge:I};localStorage.setItem(J,JSON.stringify(e))}catch(e){console.warn("Failed to save settings:",e)}}function h(){const e=document.getElementById("game-settings-summary");if(!e)return;const t={easy:"Easy",normal:"Normal",hard:"Hard"},n={en:"EN",de:"DE",es:"ES"},a=I?" \u2022 \u{1F3A4}":"";e.textContent=`${t[L]||"Normal"} \u2022 ${b}s \u2022 ${n[y]||"EN"}${a}`}function ie(e){const t=document.getElementById("media-player-summary");t&&(t.textContent=e||"Select...")}function se(e){const t=document.getElementById("media-players-list");t==null||t.removeAttribute("data-i18n");const n=e?e.length:0;p=null;const a=(e||[]).filter(i=>i.state!=="unavailable"),o=document.getElementById("media-player-validation-msg");if(n===0){const i=v?`<a href="${r.escapeHtml(v)}" target="_blank" rel="noopener">Setup Guide</a>`:"";t.innerHTML=`
            <div class="empty-state">
                <p class="status-error">No media players found. Configure a media player in Home Assistant.</p>
                ${i?`<p style="margin-top: 12px;">${i}</p>`:""}
            </div>
        `,o&&o.classList.add("hidden");return}if(a.length===0){const i=v?`<a href="${r.escapeHtml(v)}" target="_blank" rel="noopener">Troubleshooting</a>`:"";t.innerHTML=`
            <div class="empty-state">
                <p class="status-error">All media players are unavailable. Check your devices are powered on.</p>
                ${i?`<p style="margin-top: 12px;">${i}</p>`:""}
            </div>
        `,o&&o.classList.add("hidden");return}t.innerHTML=a.map(i=>{const s=i.is_mass?'<span class="mass-badge" title="Music Assistant - Apple Music enabled">Music Assistant</span>':"";return`
        <div class="media-player-item list-item is-selectable${i.is_mass?" is-mass-player":""}">
            <label class="radio-label">
                <input type="radio"
                       class="media-player-radio"
                       name="media-player"
                       data-entity-id="${r.escapeHtml(i.entity_id)}"
                       data-state="${r.escapeHtml(i.state)}"
                       data-is-mass="${i.is_mass?"true":"false"}">
                <span class="player-name">${r.escapeHtml(i.friendly_name)}${s}</span>
            </label>
            <span class="meta">
                <span class="state-dot state-${r.escapeHtml(i.state)}"></span>
                ${r.escapeHtml(i.state)}
            </span>
        </div>
    `}).join(""),t.querySelectorAll(".media-player-radio").forEach(i=>{i.addEventListener("change",function(){C(this)})}),t.querySelectorAll(".media-player-item").forEach(i=>{i.addEventListener("click",function(s){if(s.target.classList.contains("media-player-radio")||s.target.closest(".radio-label"))return;const l=i.querySelector(".media-player-radio");l&&!l.checked&&(l.checked=!0,C(l))})});const d=localStorage.getItem(R);if(d){const i=t.querySelector(`[data-entity-id="${d}"]`);if(i){i.checked=!0,C(i,!0);const s=document.getElementById("media-players");if(s){s.classList.add("collapsed");const l=document.getElementById("media-players-toggle");l&&l.setAttribute("aria-expanded","false")}}}}function C(e,t=!1){var i,s;const n=e.dataset.entityId,a=e.dataset.state;p={entityId:n,state:a},document.querySelectorAll(".media-player-item").forEach(l=>{l.classList.remove("is-selected")});const o=e.closest(".media-player-item");o.classList.add("is-selected");const d=((s=(i=o.querySelector(".player-name"))==null?void 0:i.textContent)==null?void 0:s.replace("Music Assistant","").trim())||n;if(ie(d),!t)try{localStorage.setItem(R,n)}catch(l){console.warn("Failed to save last player:",l)}_()}function oe(e,t){var o,d,i;const n=document.getElementById("playlists-list");n==null||n.removeAttribute("data-i18n"),u=[],M=e||[];const a=M.some(s=>s.is_valid);if(!e||e.length===0){const s=H?`<a href="${r.escapeHtml(H)}" target="_blank" rel="noopener">How to create playlists</a>`:"";n.innerHTML=`
            <div class="empty-state">
                <p class="status-error">No playlists found. Add playlist JSON files to:</p>
                <p style="font-size: 14px;"><code>${r.escapeHtml(t)}</code></p>
                ${s?`<p style="margin-top: 12px;">${s}</p>`:""}
            </div>
        `,(o=document.getElementById("start-game"))==null||o.classList.add("hidden");return}n.innerHTML=e.map(s=>{if(s.is_valid){const l=s.song_count||0,c=s.spotify_count||l;let m="";return c<l&&(m=`<span class="${c===0?"playlist-coverage playlist-coverage--none":"playlist-coverage playlist-coverage--warning"}">${c}/${l}</span>`),`
                <div class="playlist-item list-item is-selectable">
                    <label class="checkbox-label">
                        <input type="checkbox"
                               class="playlist-checkbox"
                               data-path="${r.escapeHtml(s.path)}"
                               data-song-count="${r.escapeHtml(String(l))}">
                        <span class="playlist-name">${r.escapeHtml(s.name)}</span>
                    </label>
                    <span class="meta">${m||r.escapeHtml(String(l))} songs</span>
                </div>
            `}else{const l=s.errors&&s.errors[0]||"Unknown error";return`
                <div class="list-item is-invalid">
                    <span class="name">${r.escapeHtml(s.name)}</span>
                    <span class="meta">Invalid: ${r.escapeHtml(l)}</span>
                </div>
            `}}).join(""),n.querySelectorAll(".playlist-checkbox").forEach(s=>{s.addEventListener("change",function(){N(this)})}),n.querySelectorAll(".playlist-item.is-selectable").forEach(s=>{s.addEventListener("click",function(l){if(l.target.classList.contains("playlist-checkbox")||l.target.closest(".checkbox-label"))return;const c=s.querySelector(".playlist-checkbox");c&&(c.checked=!c.checked,N(c))})}),a?(d=document.getElementById("start-game"))==null||d.classList.remove("hidden"):(i=document.getElementById("start-game"))==null||i.classList.add("hidden"),O()}function N(e){const t=e.dataset.path,n=parseInt(e.dataset.songCount,10)||0,a=e.closest(".playlist-item");e.checked?(u.some(o=>o.path===t)||u.push({path:t,songCount:n}),a.classList.add("is-selected")):(u=u.filter(o=>o.path!==t),a.classList.remove("is-selected")),O(),_()}function le(){return u.reduce((e,t)=>e+t.songCount,0)}function O(){const e=document.getElementById("playlist-summary"),t=document.getElementById("selected-count"),n=document.getElementById("total-songs");!e||!t||!n||(u.length===0?e.classList.add("hidden"):(e.classList.remove("hidden"),t.textContent=u.length,n.textContent=le()))}function _(){const e=document.getElementById("start-game"),t=document.getElementById("playlist-validation-msg"),n=document.getElementById("media-player-validation-msg");if(!e)return;const a=u.length===0,o=p===null;e.disabled=a||o,t&&t.classList.toggle("hidden",!a),n&&n.classList.toggle("hidden",!o)}function D(){var t,n,a;A="setup",f=null,T(),S=[],j.forEach(o=>{const d=document.getElementById(o);d&&d.classList.remove("hidden")}),M.some(o=>o.is_valid)&&((t=document.getElementById("start-game"))==null||t.classList.remove("hidden")),(n=document.getElementById("lobby-section"))==null||n.classList.add("hidden"),(a=document.getElementById("existing-game-section"))==null||a.classList.add("hidden")}function U(e){var d,i,s,l;A="lobby",f=e,j.forEach(c=>{const m=document.getElementById(c);m&&m.classList.add("hidden")}),(d=document.getElementById("start-game"))==null||d.classList.add("hidden"),(i=document.getElementById("playlist-validation-msg"))==null||i.classList.add("hidden"),(s=document.getElementById("existing-game-section"))==null||s.classList.add("hidden"),(l=document.getElementById("lobby-section"))==null||l.classList.remove("hidden");const t=document.getElementById("qr-code");t&&e.join_url&&$!==e.join_url&&(t.innerHTML="",typeof QRCode!="undefined"?new QRCode(t,{text:e.join_url,width:180,height:180,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):t.innerHTML='<p class="status-error">QR code library not loaded</p>',$=e.join_url);const n=document.getElementById("join-url");n&&e.join_url&&(n.textContent=e.join_url);var a=window.location.origin+"/beatify/dashboard",o=document.getElementById("admin-dashboard-url");o&&(o.href=a),F(e.players||[]),ve()}function ce(e){var o,d,i,s,l;A="existing-game",f=e,j.forEach(c=>{const m=document.getElementById(c);m&&m.classList.add("hidden")}),(o=document.getElementById("start-game"))==null||o.classList.add("hidden"),(d=document.getElementById("playlist-validation-msg"))==null||d.classList.add("hidden"),(i=document.getElementById("lobby-section"))==null||i.classList.add("hidden"),(s=document.getElementById("existing-game-section"))==null||s.classList.remove("hidden");const t=document.getElementById("existing-game-id"),n=document.getElementById("existing-game-phase"),a=document.getElementById("existing-game-players");t&&(t.textContent=e.game_id||"Unknown"),n&&(n.textContent=e.phase||"Unknown"),a&&(a.textContent=(l=e.player_count)!=null?l:0)}function de(){return g(this,null,function*(){const e=document.getElementById("start-game");if(!e||e.disabled)return;e.disabled=!0;const t=e.textContent;e.textContent="Starting...";try{const n=yield fetch("/beatify/api/start-game",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({playlists:u.map(o=>o.path),media_player:p==null?void 0:p.entityId,language:y,round_duration:b,difficulty:L,provider:Z,artist_challenge_enabled:I})}),a=yield n.json();if(!n.ok){E(a.message||"Failed to start game");return}a.warnings&&a.warnings.length>0&&console.warn("Game started with warnings:",a.warnings),U(a)}catch(n){E("Network error. Please try again."),console.error("Start game error:",n)}finally{e.disabled=!1,e.textContent=t,_()}})}function re(){const e=document.getElementById("end-game-modal");e&&e.classList.remove("hidden")}function k(){const e=document.getElementById("end-game-modal");e&&e.classList.add("hidden")}function P(){re()}function me(){return g(this,null,function*(){k();try{const e=yield fetch("/beatify/api/end-game",{method:"POST"});if(e.ok)$=null,D();else{const t=yield e.json();E(t.message||"Failed to end game")}}catch(e){console.error("End game error:",e),E("Network error. Please try again.")}})}function ue(){const e=document.getElementById("end-game-confirm-btn"),t=document.getElementById("end-game-cancel-btn"),n=document.querySelector("#end-game-modal .modal-backdrop");e==null||e.addEventListener("click",me),t==null||t.addEventListener("click",k),n==null||n.addEventListener("click",k)}function fe(){return g(this,null,function*(){if(f){try{var e=yield fetch("/beatify/api/status");if(e.ok){var t=yield e.json();t.active_game&&(f=t.active_game)}}catch(n){console.error("Failed to refresh game status:",n)}U(f)}})}function ge(){window.print()}function E(e){alert(e)}function ye(){var t;const e=document.getElementById("admin-join-modal");e&&(e.classList.remove("hidden"),(t=document.getElementById("admin-name-input"))==null||t.focus())}function q(){const e=document.getElementById("admin-join-modal");e&&e.classList.add("hidden");const t=document.getElementById("admin-name-input"),n=document.getElementById("admin-join-btn"),a=document.getElementById("admin-name-error");t&&(t.value=""),n&&(n.disabled=!0,n.textContent="Join"),a&&a.classList.add("hidden")}function pe(){const e=document.getElementById("participate-btn"),t=document.getElementById("admin-cancel-btn"),n=document.getElementById("admin-join-btn"),a=document.getElementById("admin-name-input"),o=document.querySelector("#admin-join-modal .modal-backdrop");e==null||e.addEventListener("click",ye),t==null||t.addEventListener("click",q),o==null||o.addEventListener("click",q),a==null||a.addEventListener("input",function(){const d=this.value.trim();n.disabled=!d||d.length>20}),a==null||a.addEventListener("keypress",function(d){d.key==="Enter"&&!n.disabled&&G()}),n==null||n.addEventListener("click",G),document.addEventListener("keydown",function(d){if(d.key==="Escape"){const i=document.getElementById("admin-join-modal"),s=document.getElementById("end-game-modal");i&&!i.classList.contains("hidden")&&q(),s&&!s.classList.contains("hidden")&&k()}})}function G(){const e=document.getElementById("admin-name-input"),t=document.getElementById("admin-join-btn"),n=e==null?void 0:e.value.trim();if(n){t.disabled=!0,t.textContent="Joining...";try{sessionStorage.setItem("beatify_admin_name",n),sessionStorage.setItem("beatify_is_admin","true");const a=f==null?void 0:f.game_id;a?window.location.href="/beatify/play?game="+encodeURIComponent(a):(E("No active game found"),t.disabled=!1,t.textContent="Join")}catch(a){console.error("Admin join failed:",a),t.disabled=!1,t.textContent="Join"}}}function F(e){var t=document.getElementById("lobby-players"),n=document.getElementById("lobby-player-count"),a=document.getElementById("admin-players-summary"),o=document.getElementById("lobby-players-empty"),d=document.getElementById("lobby-status-value");if(t){if(e=e||[],n&&(n.textContent=e.length),a&&(a.textContent=e.length),d&&(e.length===0?d.textContent=r.t("lobby.statusWaiting","Waiting"):e.length>=2?d.textContent=r.t("lobby.statusReady","Ready"):d.textContent=r.t("lobby.statusNeedMore","Need 1+")),e.length===0){t.innerHTML="",o&&o.classList.remove("hidden"),S=[];return}o&&o.classList.add("hidden");var i=e.slice().sort(function(c,m){return c.connected!==m.connected?c.connected?-1:1:0}),s=S.map(function(c){return c.name}),l=i.filter(function(c){return s.indexOf(c.name)===-1}).map(function(c){return c.name});t.innerHTML=i.map(function(c){var m=l.indexOf(c.name)!==-1,x=c.connected===!1,Q=c.is_admin===!0,W=["player-card",m?"is-new":"",x?"player-card--disconnected":""].filter(Boolean).join(" "),z=Q?'<span class="admin-badge">\u{1F451}</span>':"",Y=x?'<span class="away-badge">'+r.t("lobby.away","away")+"</span>":"";return'<div class="'+W+'" data-player="'+r.escapeHtml(c.name)+'"><span class="player-name">'+r.escapeHtml(c.name)+z+"</span>"+Y+"</div>"}).join(""),setTimeout(function(){for(var c=t.querySelectorAll(".is-new"),m=0;m<c.length;m++)c[m].classList.remove("is-new")},2e3),S=e.slice()}}function ve(){T(),w=setInterval(function(){return g(this,null,function*(){if(A!=="lobby"){T();return}try{var e=yield fetch("/beatify/api/status");if(!e.ok)return;var t=yield e.json();t.active_game&&t.active_game.players&&F(t.active_game.players)}catch(n){console.error("Lobby polling error:",n)}})},3e3)}function T(){w&&(clearInterval(w),w=null)}"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/beatify/static/sw.js",{scope:"/beatify/"}).then(function(e){console.log("[Admin] SW registered:",e.scope)}).catch(function(e){console.warn("[Admin] SW registration failed:",e)})})});he();})();
//# sourceMappingURL=admin.min.js.map

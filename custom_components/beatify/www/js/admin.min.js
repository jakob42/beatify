let selectedPlaylists=[],playlistData=[],playlistDocsUrl="",activeFilterTags=["all"],selectedMediaPlayer=null,mediaPlayerDocsUrl="",currentView="setup",currentGame=null,cachedQRUrl=null,selectedLanguage="en",selectedDuration=45,selectedDifficulty="normal",selectedProvider="spotify",hasMusicAssistant=!1,artistChallengeEnabled=!0,introModeEnabled=!1,previousLobbyPlayers=[],lobbyPollingInterval=null;const STORAGE_LAST_PLAYER="beatify_last_player",STORAGE_GAME_SETTINGS="beatify_game_settings",setupSections=["media-players","music-service","playlists","game-settings","admin-actions","my-requests"],PLATFORM_LABELS={music_assistant:{icon:"üéµ",label:"Music Assistant",recommended:!0},sonos:{icon:"üîä",label:"Sonos"},alexa_media:{icon:"üì¢",label:"Alexa"},alexa:{icon:"üì¢",label:"Alexa"}},utils=window.BeatifyUtils||{};async function loadStatus(){try{const e=await fetch("/beatify/api/status");if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();playlistDocsUrl=t.playlist_docs_url||"",mediaPlayerDocsUrl=t.media_player_docs_url||"",hasMusicAssistant=!0===t.has_music_assistant;const a=document.getElementById("app-version");a&&t.version&&(a.textContent="v"+t.version,window.BEATIFY_VERSION=t.version),renderMediaPlayers(t.media_players),renderPlaylists(t.playlists,t.playlist_dir),updateStartButtonState(),t.active_game&&"END"!==t.active_game.phase?showExistingGameView(t.active_game):showSetupView()}catch(e){console.error("Failed to load status:",e);const t=document.getElementById("media-players-list");t&&(t.innerHTML='<span class="status-error">Failed to load status</span>')}}function setupCollapsibleSections(){document.getElementById("media-players-toggle")?.addEventListener("click",function(){const e=document.getElementById("media-players");e&&(e.classList.toggle("collapsed"),this.setAttribute("aria-expanded",!e.classList.contains("collapsed")))}),document.getElementById("game-settings-toggle")?.addEventListener("click",function(){const e=document.getElementById("game-settings");e&&(e.classList.toggle("collapsed"),this.setAttribute("aria-expanded",!e.classList.contains("collapsed")))}),document.getElementById("my-requests-toggle")?.addEventListener("click",function(){const e=document.getElementById("my-requests");e&&(e.classList.toggle("collapsed"),this.setAttribute("aria-expanded",!e.classList.contains("collapsed")))}),document.querySelectorAll(".lobby-container--compact .section-header-collapsible").forEach(function(e){e.addEventListener("click",function(){const t=e.closest(".section-collapsible");t&&(t.classList.toggle("collapsed"),e.setAttribute("aria-expanded",!t.classList.contains("collapsed")))})})}function setupGameSettings(){document.querySelectorAll(".chip[data-lang]").forEach(e=>{e.addEventListener("click",async function(){const e=this.dataset.lang;document.querySelectorAll(".chip[data-lang]").forEach(e=>e.classList.remove("chip--active")),this.classList.add("chip--active"),selectedLanguage=e,window.BeatifyI18n&&(await BeatifyI18n.setLanguage(e),BeatifyI18n.initPageTranslations()),updateGameSettingsSummary(),saveGameSettings()})}),document.querySelectorAll(".chip[data-duration]").forEach(e=>{e.addEventListener("click",function(){const e=parseInt(this.dataset.duration,10);document.querySelectorAll(".chip[data-duration]").forEach(e=>e.classList.remove("chip--active")),this.classList.add("chip--active"),selectedDuration=e,updateGameSettingsSummary(),saveGameSettings()})}),document.querySelectorAll(".chip[data-difficulty]").forEach(e=>{e.addEventListener("click",function(){const e=this.dataset.difficulty;document.querySelectorAll(".chip[data-difficulty]").forEach(e=>e.classList.remove("chip--active")),this.classList.add("chip--active"),selectedDifficulty=e,updateGameSettingsSummary(),saveGameSettings()})}),document.getElementById("artist-challenge-toggle")?.addEventListener("change",function(){artistChallengeEnabled=this.checked,updateGameSettingsSummary(),saveGameSettings()}),document.getElementById("intro-mode-toggle")?.addEventListener("change",function(){introModeEnabled=this.checked,updateGameSettingsSummary(),saveGameSettings()}),document.querySelectorAll(".chip[data-provider]").forEach(e=>{e.addEventListener("click",function(){if(this.disabled||this.classList.contains("chip--disabled"))return;const e=this.dataset.provider;document.querySelectorAll(".chip[data-provider]").forEach(e=>e.classList.remove("chip--active")),this.classList.add("chip--active"),selectedProvider=e,updateGameSettingsSummary(),saveGameSettings(),playlistData.length>0&&renderPlaylists(playlistData,"",!0)})})}async function loadSavedSettings(){try{const e=localStorage.getItem(STORAGE_GAME_SETTINGS);if(e){const t=JSON.parse(e);if(t.language&&(selectedLanguage=t.language,document.querySelectorAll(".chip[data-lang]").forEach(e=>{e.classList.toggle("chip--active",e.dataset.lang===t.language)}),window.BeatifyI18n&&await BeatifyI18n.setLanguage(t.language)),t.duration&&(selectedDuration=t.duration,document.querySelectorAll(".chip[data-duration]").forEach(e=>{e.classList.toggle("chip--active",parseInt(e.dataset.duration,10)===t.duration)})),t.difficulty&&(selectedDifficulty=t.difficulty,document.querySelectorAll(".chip[data-difficulty]").forEach(e=>{e.classList.toggle("chip--active",e.dataset.difficulty===t.difficulty)})),"boolean"==typeof t.artistChallenge){artistChallengeEnabled=t.artistChallenge;const e=document.getElementById("artist-challenge-toggle");e&&(e.checked=t.artistChallenge)}if("boolean"==typeof t.introMode){introModeEnabled=t.introMode;const e=document.getElementById("intro-mode-toggle");e&&(e.checked=t.introMode)}t.provider&&(selectedProvider=t.provider,document.querySelectorAll(".chip[data-provider]").forEach(e=>{e.classList.toggle("chip--active",e.dataset.provider===t.provider)}))}}catch(e){console.warn("Failed to load saved settings:",e)}updateGameSettingsSummary()}function saveGameSettings(){try{const e={language:selectedLanguage,duration:selectedDuration,difficulty:selectedDifficulty,artistChallenge:artistChallengeEnabled,introMode:introModeEnabled,provider:selectedProvider};localStorage.setItem(STORAGE_GAME_SETTINGS,JSON.stringify(e))}catch(e){console.warn("Failed to save settings:",e)}}function updateGameSettingsSummary(){const e=document.getElementById("game-settings-summary");if(!e)return;const t=artistChallengeEnabled?" ‚Ä¢ üé§":"",a=introModeEnabled?" ‚Ä¢ ‚ö°":"";e.textContent=`${{easy:"Easy",normal:"Normal",hard:"Hard"}[selectedDifficulty]||"Normal"} ‚Ä¢ ${selectedDuration}s ‚Ä¢ ${{en:"EN",de:"DE",es:"ES"}[selectedLanguage]||"EN"}${t}${a}`}function updateMediaPlayerSummary(e){const t=document.getElementById("media-player-summary");t&&(t.textContent=e||"Select...")}function groupPlayersByPlatform(e){const t={};return e.forEach(e=>{const a=e.platform||"unknown";t[a]||(t[a]=[]),t[a].push(e)}),t}function renderMediaPlayers(e){const t=document.getElementById("media-players-list");t?.removeAttribute("data-i18n");const a=e?e.length:0;selectedMediaPlayer=null;const n=(e||[]).filter(e=>"unavailable"!==e.state),s=document.getElementById("media-player-validation-msg");if(0===a){t.innerHTML='\n            <div class="no-players-message">\n                <h3>üéµ No Compatible Players Found</h3>\n                <p>Beatify works with Music Assistant, Sonos, and Alexa players.</p>\n                <p><strong>Recommended:</strong> Install Music Assistant for the best experience with any speaker.</p>\n                <div class="button-group">\n                    <a href="https://music-assistant.io/getting-started/"\n                       target="_blank" class="btn btn-secondary">\n                        üìñ Music Assistant Setup Guide\n                    </a>\n                    <button onclick="loadStatus()" class="btn btn-primary">\n                        üîÑ Refresh\n                    </button>\n                </div>\n            </div>\n        ',s&&s.classList.add("hidden");const e=document.getElementById("start-game");return void(e&&(e.disabled=!0))}if(0===n.length){const e=mediaPlayerDocsUrl?`<a href="${utils.escapeHtml(mediaPlayerDocsUrl)}" target="_blank" rel="noopener">Troubleshooting</a>`:"";return t.innerHTML=`\n            <div class="empty-state">\n                <p class="status-error">All media players are unavailable. Check your devices are powered on.</p>\n                ${e?`<p style="margin-top: 12px;">${e}</p>`:""}\n            </div>\n        `,void(s&&s.classList.add("hidden"))}t.innerHTML=n.map(e=>renderPlayerItem(e)).join(""),attachPlayerSelectionHandlers();const i=localStorage.getItem(STORAGE_LAST_PLAYER);if(i){const e=t.querySelector(`[data-entity-id="${i}"]`);if(e){e.checked=!0,handleMediaPlayerSelect(e,!0);const t=document.getElementById("media-players");if(t){t.classList.add("collapsed");const e=document.getElementById("media-players-toggle");e&&e.setAttribute("aria-expanded","false")}}}}function renderPlayerItem(e){const t=PLATFORM_LABELS[e.platform]||{icon:"üîà",label:e.platform},a=`<span class="platform-badge platform-badge--${utils.escapeHtml(e.platform)}">${t.icon} ${t.label}</span>`;return`\n        <div class="media-player-item list-item is-selectable"\n             data-entity-id="${utils.escapeHtml(e.entity_id)}"\n             data-platform="${utils.escapeHtml(e.platform)}"\n             data-supports-spotify="${e.supports_spotify}"\n             data-supports-apple-music="${e.supports_apple_music}"\n             data-supports-youtube-music="${e.supports_youtube_music}"\n             data-supports-tidal="${e.supports_tidal}">\n            <label class="radio-label">\n                <input type="radio"\n                       class="media-player-radio"\n                       name="media-player"\n                       data-entity-id="${utils.escapeHtml(e.entity_id)}"\n                       data-state="${utils.escapeHtml(e.state)}"\n                       data-platform="${utils.escapeHtml(e.platform)}"\n                       data-supports-spotify="${e.supports_spotify}"\n                       data-supports-apple-music="${e.supports_apple_music}"\n                       data-supports-youtube-music="${e.supports_youtube_music}"\n                       data-supports-tidal="${e.supports_tidal}">\n                <span class="player-info">\n                    <span class="player-name">${utils.escapeHtml(e.friendly_name)}</span>\n                    ${a}\n                </span>\n            </label>\n            <span class="meta">\n                <span class="state-dot state-${utils.escapeHtml(e.state)}"></span>\n                ${utils.escapeHtml(e.state)}\n            </span>\n        </div>\n    `}function attachPlayerSelectionHandlers(){const e=document.getElementById("media-players-list");e&&(e.querySelectorAll(".media-player-radio").forEach(e=>{e.addEventListener("change",function(){handleMediaPlayerSelect(this)})}),e.querySelectorAll(".media-player-item").forEach(e=>{e.addEventListener("click",function(t){if(t.target.classList.contains("media-player-radio")||t.target.closest(".radio-label"))return;const a=e.querySelector(".media-player-radio");a&&!a.checked&&(a.checked=!0,handleMediaPlayerSelect(a))})}))}function handleMediaPlayerSelect(e,t=!1){const a=e.dataset.entityId,n=e.dataset.state,s=e.dataset.platform,i="true"===e.dataset.supportsSpotify,l="true"===e.dataset.supportsAppleMusic,o="true"===e.dataset.supportsYoutubeMusic,d="true"===e.dataset.supportsTidal;selectedMediaPlayer={entityId:a,state:n,platform:s,supportsSpotify:i,supportsAppleMusic:l,supportsYoutubeMusic:o,supportsTidal:d},document.querySelectorAll(".media-player-item").forEach(e=>{e.classList.remove("is-selected")});const c=e.closest(".media-player-item");c.classList.add("is-selected");updateMediaPlayerSummary(c.querySelector(".player-name")?.textContent?.trim()||a);const r=document.getElementById("music-service");if(r&&r.classList.remove("hidden"),updateProviderOptions(selectedMediaPlayer),updateProviderWarning(selectedMediaPlayer),!t)try{localStorage.setItem(STORAGE_LAST_PLAYER,a)}catch(e){console.warn("Failed to save last player:",e)}updateStartButtonState()}function updateProviderOptions(e){const t=document.querySelector('.chip[data-provider="spotify"]'),a=document.querySelector('.chip[data-provider="apple_music"]'),n=document.querySelector('.chip[data-provider="youtube_music"]'),s=document.querySelector('.chip[data-provider="tidal"]');t&&(t.disabled=!e.supportsSpotify,t.classList.toggle("chip--disabled",!e.supportsSpotify)),a&&(a.disabled=!e.supportsAppleMusic,a.classList.toggle("chip--disabled",!e.supportsAppleMusic)),n&&(n.disabled=!e.supportsYoutubeMusic,n.classList.toggle("chip--disabled",!e.supportsYoutubeMusic)),s&&(s.disabled=!e.supportsTidal,s.classList.toggle("chip--disabled",!e.supportsTidal)),"apple_music"!==selectedProvider||e.supportsAppleMusic||(document.querySelectorAll(".chip[data-provider]").forEach(e=>e.classList.remove("chip--active")),t&&t.classList.add("chip--active"),selectedProvider="spotify"),"youtube_music"!==selectedProvider||e.supportsYoutubeMusic||(document.querySelectorAll(".chip[data-provider]").forEach(e=>e.classList.remove("chip--active")),t&&t.classList.add("chip--active"),selectedProvider="spotify"),"tidal"!==selectedProvider||e.supportsTidal||(document.querySelectorAll(".chip[data-provider]").forEach(e=>e.classList.remove("chip--active")),t&&t.classList.add("chip--active"),selectedProvider="spotify");const i=document.getElementById("provider-hint");if(i){const t=[];e.supportsAppleMusic||t.push("Apple Music"),e.supportsYoutubeMusic||t.push("YouTube Music"),e.supportsTidal||t.push("Tidal"),t.length>0?(i.textContent=`${t.join(" and ")} require${1===t.length?"s":""} Music Assistant speaker`,i.classList.remove("hidden")):i.classList.add("hidden")}}function updateProviderWarning(e){const t=document.getElementById("provider-warning");if(!t)return;const a={music_assistant:{warning:"Premium account must be configured in Music Assistant"},sonos:{warning:"Spotify must be linked in Sonos app"},alexa_media:{warning:"Service must be linked in Alexa app",caveat:"Uses voice search - may occasionally play a different version of the song"},alexa:{warning:"Service must be linked in Alexa app",caveat:"Uses voice search - may occasionally play a different version of the song"}}[e.platform];if(a){let e=`<p>‚ö†Ô∏è ${utils.escapeHtml(a.warning)}</p>`;a.caveat&&(e+=`<p class="warning-caveat">‚ÑπÔ∏è ${utils.escapeHtml(a.caveat)}</p>`),t.innerHTML=e,t.classList.remove("hidden")}else t.classList.add("hidden")}function renderPlaylists(e,t,a=!1){const n=document.getElementById("playlists-list");n?.removeAttribute("data-i18n");const s=a?[...selectedPlaylists]:[];selectedPlaylists=[],playlistData=e||[],renderPlaylistFilterBar(playlistData);let i=playlistData;!activeFilterTags.includes("all")&&activeFilterTags.length>0&&(i=playlistData.filter(e=>{const t=e.tags||[];return activeFilterTags.every(e=>t.includes(e))}));const l=playlistData.some(e=>e.is_valid);if(!playlistData||0===playlistData.length){const e=playlistDocsUrl?`<a href="${utils.escapeHtml(playlistDocsUrl)}" target="_blank" rel="noopener">How to create playlists</a>`:"";return n.innerHTML=`\n            <div class="empty-state">\n                <p class="status-error">No playlists found. Add playlist JSON files to:</p>\n                <p style="font-size: 14px;"><code>${utils.escapeHtml(t)}</code></p>\n                ${e?`<p style="margin-top: 12px;">${e}</p>`:""}\n            </div>\n        `,void document.getElementById("start-game")?.classList.add("hidden")}0!==i.length?(n.innerHTML=i.map(e=>{if(e.is_valid){const t=e.song_count||0,a=e.spotify_count||0,n=e.apple_music_count||0,s=e.youtube_music_count||0,i=e.tidal_count||0;let l=t;"spotify"===selectedProvider?l=a||t:"apple_music"===selectedProvider?l=n:"youtube_music"===selectedProvider?l=s:"tidal"===selectedProvider&&(l=i);const o=0===l,d=o?"disabled":"";let c="";if(l<t){c=`<span class="${0===l?"playlist-coverage playlist-coverage--none":"playlist-coverage playlist-coverage--warning"}">${l}/${t}</span>`}return`\n                <div class="playlist-item list-item ${o?"":"is-selectable"} ${o?"is-disabled":""}"\n                     data-provider-count="${l}"\n                     data-tags="${utils.escapeHtml((e.tags||[]).join(","))}">\n                    <label class="checkbox-label">\n                        <input type="checkbox"\n                               class="playlist-checkbox"\n                               data-path="${utils.escapeHtml(e.path)}"\n                               data-song-count="${utils.escapeHtml(String(t))}"\n                               data-provider-count="${l}"\n                               ${d}>\n                        <span class="playlist-name">${utils.escapeHtml(e.name)}</span>\n                    </label>\n                    <span class="meta">${c||utils.escapeHtml(String(t))} songs</span>\n                </div>\n            `}{const t=e.errors&&e.errors[0]||"Unknown error";return`\n                <div class="list-item is-invalid">\n                    <span class="name">${utils.escapeHtml(e.name)}</span>\n                    <span class="meta">Invalid: ${utils.escapeHtml(t)}</span>\n                </div>\n            `}}).join(""),n.querySelectorAll(".playlist-checkbox").forEach(e=>{e.addEventListener("change",function(){handlePlaylistToggle(this)})}),n.querySelectorAll(".playlist-item.is-selectable").forEach(e=>{e.addEventListener("click",function(t){if(t.target.classList.contains("playlist-checkbox")||t.target.closest(".checkbox-label"))return;const a=e.querySelector(".playlist-checkbox");a&&(a.checked=!a.checked,handlePlaylistToggle(a))})}),a&&s.length>0&&s.forEach(e=>{const t=n.querySelector(`.playlist-checkbox[data-path="${CSS.escape(e.path)}"]`);if(t&&!t.disabled){t.checked=!0;const a=parseInt(t.dataset.providerCount,10)||0,n=t.closest(".playlist-item");a>0&&(selectedPlaylists.push({path:e.path,songCount:a}),n?.classList.add("is-selected"))}}),l?document.getElementById("start-game")?.classList.remove("hidden"):document.getElementById("start-game")?.classList.add("hidden"),updateSelectionSummary(),updateStartButtonState()):n.innerHTML='\n            <div class="empty-state">\n                <p>No playlists match the selected filter.</p>\n                <button type="button" class="btn btn-secondary" onclick="clearPlaylistFilters()">Clear Filters</button>\n            </div>\n        '}function handlePlaylistToggle(e){const t=e.dataset.path,a=parseInt(e.dataset.providerCount,10)||0,n=e.closest(".playlist-item");e.checked?(selectedPlaylists.some(e=>e.path===t)||selectedPlaylists.push({path:t,songCount:a}),n.classList.add("is-selected")):(selectedPlaylists=selectedPlaylists.filter(e=>e.path!==t),n.classList.remove("is-selected")),updateSelectionSummary(),updateStartButtonState()}document.addEventListener("DOMContentLoaded",async()=>{await utils.waitForI18n()?(await BeatifyI18n.init(),BeatifyI18n.initPageTranslations(),selectedLanguage=BeatifyI18n.getLanguage()):console.error("[Beatify] BeatifyI18n module failed to load - UI will use fallback text"),document.querySelectorAll(".chip[data-lang]").forEach(e=>{e.classList.toggle("chip--active",e.dataset.lang===selectedLanguage)}),document.getElementById("start-game")?.addEventListener("click",startGame),document.getElementById("print-qr")?.addEventListener("click",printQRCode),document.getElementById("rejoin-game")?.addEventListener("click",rejoinGame),document.getElementById("end-game")?.addEventListener("click",endGame),document.getElementById("end-game-lobby")?.addEventListener("click",endGame),document.getElementById("end-game-existing")?.addEventListener("click",endGame),document.getElementById("rematch-game")?.addEventListener("click",showRematchModal),document.getElementById("dismiss-game")?.addEventListener("click",endGame),setupAdminJoin(),setupEndGameModal(),setupRematchModal(),setupCollapsibleSections(),setupGameSettings(),setupPlaylistRequests(),await loadSavedSettings(),await loadStatus(),initPlaylistRequests()});const TAG_CATEGORIES={decade:{label:"Decade",tags:["1960s","1970s","1980s","1990s","2000s"]},style:{label:"Style",tags:["rock","pop","ballads","electronic","eurodance","yacht-rock","soft-rock","pop-punk","schlager","party","britpop","british-invasion","classic-rock","dance","disco","funk","hip-hop","latin","merengue","motown","r&b","salsa","soul"]},region:{label:"Region",tags:["international","german","dutch","spanish"]},special:{label:"Special",tags:["movies","soundtrack","eurovision","carnival","classics","contest","mixed","one-hit","top-hits"]}};let activeFilters={decade:"",style:"",region:"",special:""};function renderPlaylistFilterBar(e){const t=document.getElementById("playlist-filter-bar");if(!t)return;const a=new Set;if(e.forEach(e=>{(e.tags||[]).forEach(e=>a.add(e))}),0===a.size)return void t.classList.add("hidden");const n=e=>e.charAt(0).toUpperCase()+e.slice(1);let s='<div class="filter-dropdowns">';Object.entries(TAG_CATEGORIES).forEach(([e,t])=>{const i=t.tags.filter(e=>a.has(e));if(0===i.length)return;const l=activeFilters[e]||"";s+=`\n            <select class="filter-dropdown" data-category="${e}">\n                <option value="">${t.label}</option>\n                ${i.map(e=>{const t=l===e?"selected":"";return`<option value="${utils.escapeHtml(e)}" ${t}>${n(e)}</option>`}).join("")}\n            </select>\n        `}),s+="</div>";const i=Object.entries(activeFilters).filter(([e,t])=>t).map(([e,t])=>n(t));i.length>0&&(s+=`\n            <div class="filter-summary">\n                <span class="filter-summary-text">Showing: ${i.join(" ‚Ä¢ ")}</span>\n                <button type="button" class="filter-clear" onclick="clearPlaylistFilters()">Clear</button>\n            </div>\n        `),t.innerHTML=s,t.classList.remove("hidden"),t.querySelectorAll(".filter-dropdown").forEach(e=>{e.addEventListener("change",function(){handleFilterDropdownChange(this.dataset.category,this.value)})})}function handleFilterDropdownChange(e,t){activeFilters[e]=t,updateActiveFilterTags(),renderPlaylists(playlistData,"",!0)}function updateActiveFilterTags(){const e=Object.values(activeFilters).filter(e=>e);activeFilterTags=e.length>0?e:["all"]}function clearPlaylistFilters(){activeFilters={decade:"",style:"",region:"",special:""},activeFilterTags=["all"],renderPlaylists(playlistData,"",!0)}function calculateTotalSongs(){return selectedPlaylists.reduce((e,t)=>e+t.songCount,0)}function updateSelectionSummary(){const e=document.getElementById("playlist-summary"),t=document.getElementById("selected-count"),a=document.getElementById("total-songs");e&&t&&a&&(0===selectedPlaylists.length?e.classList.add("hidden"):(e.classList.remove("hidden"),t.textContent=selectedPlaylists.length,a.textContent=calculateTotalSongs()))}function updateStartButtonState(){const e=document.getElementById("start-game"),t=document.getElementById("playlist-validation-msg"),a=document.getElementById("media-player-validation-msg");if(!e)return;const n=0===selectedPlaylists.length,s=null===selectedMediaPlayer;e.disabled=n||s,t&&t.classList.toggle("hidden",!n),a&&a.classList.toggle("hidden",!s)}function showSetupView(){currentView="setup",currentGame=null,stopLobbyPolling(),previousLobbyPlayers=[],setupSections.forEach(e=>{const t=document.getElementById(e);t&&t.classList.remove("hidden")});playlistData.some(e=>e.is_valid)&&document.getElementById("start-game")?.classList.remove("hidden"),document.getElementById("lobby-section")?.classList.add("hidden"),document.getElementById("existing-game-section")?.classList.add("hidden")}function showLobbyView(e){currentView="lobby",currentGame=e,setupSections.forEach(e=>{const t=document.getElementById(e);t&&t.classList.add("hidden")}),document.getElementById("start-game")?.classList.add("hidden"),document.getElementById("playlist-validation-msg")?.classList.add("hidden"),document.getElementById("existing-game-section")?.classList.add("hidden"),document.getElementById("lobby-section")?.classList.remove("hidden");const t=document.getElementById("qr-code");t&&e.join_url&&cachedQRUrl!==e.join_url&&(t.innerHTML="","undefined"!=typeof QRCode?new QRCode(t,{text:e.join_url,width:180,height:180,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):t.innerHTML='<p class="status-error">QR code library not loaded</p>',cachedQRUrl=e.join_url);const a=document.getElementById("join-url");a&&e.join_url&&(a.textContent=e.join_url);var n=window.location.origin+"/beatify/dashboard",s=document.getElementById("admin-dashboard-url");s&&(s.href=n),renderLobbyPlayers(e.players||[]),startLobbyPolling(),updateLobbyDifficultyBadge(e.difficulty||selectedDifficulty),setupQRModal()}function openQRModal(){if(cachedQRUrl){var e=document.getElementById("qr-modal"),t=document.getElementById("qr-modal-code");if(e&&t){t.innerHTML="","undefined"!=typeof QRCode&&new QRCode(t,{text:cachedQRUrl,width:280,height:280,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}),e.classList.remove("hidden"),document.body.style.overflow="hidden";var a=document.getElementById("qr-modal-close");a&&a.focus()}}}function closeQRModal(){var e=document.getElementById("qr-modal");e&&(e.classList.add("hidden"),document.body.style.overflow="")}function setupQRModal(){var e=document.getElementById("admin-qr-container"),t=document.getElementById("qr-modal"),a=t?t.querySelector(".qr-modal-backdrop"):null,n=document.getElementById("qr-modal-close");e&&(e.addEventListener("click",openQRModal),e.addEventListener("keydown",function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),openQRModal())})),a&&a.addEventListener("click",closeQRModal),n&&n.addEventListener("click",closeQRModal),document.addEventListener("keydown",function(e){"Escape"===e.key&&t&&!t.classList.contains("hidden")&&closeQRModal()})}function showExistingGameView(e){currentView="existing-game",currentGame=e,setupSections.forEach(e=>{const t=document.getElementById(e);t&&t.classList.add("hidden")}),document.getElementById("start-game")?.classList.add("hidden"),document.getElementById("playlist-validation-msg")?.classList.add("hidden"),document.getElementById("lobby-section")?.classList.add("hidden"),document.getElementById("existing-game-section")?.classList.remove("hidden");const t=document.getElementById("existing-game-id"),a=document.getElementById("existing-game-phase"),n=document.getElementById("existing-game-players");t&&(t.textContent=e.game_id||"Unknown"),a&&(a.textContent=e.phase||"Unknown"),n&&(n.textContent=e.player_count??0);var s=document.getElementById("end-phase-actions"),i=document.getElementById("existing-game-actions");s&&i&&("END"===e.phase?(s.classList.remove("hidden"),i.classList.add("hidden")):(s.classList.add("hidden"),i.classList.remove("hidden")))}async function startGame(){const e=document.getElementById("start-game");if(!e||e.disabled)return;e.disabled=!0;const t=e.textContent;e.textContent="Starting...";try{const e=await fetch("/beatify/api/start-game",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({playlists:selectedPlaylists.map(e=>e.path),media_player:selectedMediaPlayer?.entityId,language:selectedLanguage,round_duration:selectedDuration,difficulty:selectedDifficulty,provider:selectedProvider,artist_challenge_enabled:artistChallengeEnabled,intro_mode_enabled:introModeEnabled})}),t=await e.json();if(!e.ok)return void showError(t.message||"Failed to start game");t.warnings&&t.warnings.length>0&&console.warn("Game started with warnings:",t.warnings),showLobbyView(t)}catch(e){showError("Network error. Please try again."),console.error("Start game error:",e)}finally{e.disabled=!1,e.textContent=t,updateStartButtonState()}}function showEndGameModal(){const e=document.getElementById("end-game-modal");e&&e.classList.remove("hidden")}function closeEndGameModal(){const e=document.getElementById("end-game-modal");e&&e.classList.add("hidden")}function endGame(){showEndGameModal()}async function confirmEndGame(){closeEndGameModal();try{const e=await fetch("/beatify/api/end-game",{method:"POST"});if(e.ok)cachedQRUrl=null,showSetupView();else{showError((await e.json()).message||"Failed to end game")}}catch(e){console.error("End game error:",e),showError("Network error. Please try again.")}}function setupEndGameModal(){const e=document.getElementById("end-game-confirm-btn"),t=document.getElementById("end-game-cancel-btn"),a=document.querySelector("#end-game-modal .modal-backdrop");e?.addEventListener("click",confirmEndGame),t?.addEventListener("click",closeEndGameModal),a?.addEventListener("click",closeEndGameModal)}window.clearPlaylistFilters=clearPlaylistFilters;var rematchInProgress=!1;function showRematchModal(){var e=document.getElementById("rematch-modal");e&&e.classList.remove("hidden")}function closeRematchModal(){var e=document.getElementById("rematch-modal");e&&e.classList.add("hidden")}async function confirmRematch(){if(!rematchInProgress){rematchInProgress=!0;var e=document.getElementById("rematch-game"),t=e?e.textContent:"";e&&(e.disabled=!0,e.textContent="‚è≥"),closeRematchModal();try{var a=await fetch("/beatify/api/rematch-game",{method:"POST"});if(a.ok)showSetupView();else{var n=await a.json();alert(n.message||"Failed to start rematch")}}catch(e){console.error("Rematch failed:",e),alert("Failed to start rematch")}finally{rematchInProgress=!1,e&&(e.disabled=!1,e.textContent=t)}}}function setupRematchModal(){var e=document.getElementById("rematch-confirm-btn"),t=document.getElementById("rematch-cancel-btn"),a=document.querySelector("#rematch-modal .modal-backdrop");e?.addEventListener("click",confirmRematch),t?.addEventListener("click",closeRematchModal),a?.addEventListener("click",closeRematchModal),document.addEventListener("keydown",function(e){if("Escape"===e.key){var t=document.getElementById("rematch-modal");t&&!t.classList.contains("hidden")&&closeRematchModal()}})}async function rejoinGame(){if(currentGame){try{var e=await fetch("/beatify/api/status");if(e.ok){var t=await e.json();t.active_game&&(currentGame=t.active_game)}}catch(e){console.error("Failed to refresh game status:",e)}showLobbyView(currentGame)}}function printQRCode(){window.print()}function showError(e){alert(e)}function openAdminJoinModal(){const e=document.getElementById("admin-join-modal");e&&(e.classList.remove("hidden"),document.getElementById("admin-name-input")?.focus())}function closeAdminJoinModal(){const e=document.getElementById("admin-join-modal");e&&e.classList.add("hidden");const t=document.getElementById("admin-name-input"),a=document.getElementById("admin-join-btn"),n=document.getElementById("admin-name-error");t&&(t.value=""),a&&(a.disabled=!0,a.textContent="Join"),n&&n.classList.add("hidden")}function setupAdminJoin(){const e=document.getElementById("participate-btn"),t=document.getElementById("admin-cancel-btn"),a=document.getElementById("admin-join-btn"),n=document.getElementById("admin-name-input"),s=document.querySelector("#admin-join-modal .modal-backdrop");e?.addEventListener("click",openAdminJoinModal),t?.addEventListener("click",closeAdminJoinModal),s?.addEventListener("click",closeAdminJoinModal),n?.addEventListener("input",function(){const e=this.value.trim();a.disabled=!e||e.length>20}),n?.addEventListener("keypress",function(e){"Enter"!==e.key||a.disabled||handleAdminJoin()}),a?.addEventListener("click",handleAdminJoin),document.addEventListener("keydown",function(e){if("Escape"===e.key){const e=document.getElementById("admin-join-modal"),t=document.getElementById("end-game-modal");e&&!e.classList.contains("hidden")&&closeAdminJoinModal(),t&&!t.classList.contains("hidden")&&closeEndGameModal()}})}function handleAdminJoin(){const e=document.getElementById("admin-name-input"),t=document.getElementById("admin-join-btn"),a=e?.value.trim();if(a){t.disabled=!0,t.textContent="Joining...";try{sessionStorage.setItem("beatify_admin_name",a),sessionStorage.setItem("beatify_is_admin","true");const e=currentGame?.game_id;e?window.location.href="/beatify/play?game="+encodeURIComponent(e):(showError("No active game found"),t.disabled=!1,t.textContent="Join")}catch(e){console.error("Admin join failed:",e),t.disabled=!1,t.textContent="Join"}}}function setupLanguageSelector(){document.querySelectorAll(".lang-btn").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-lang");t&&t!==selectedLanguage&&setLanguage(t)})})}function updateLanguageButtons(e){document.querySelectorAll(".lang-btn").forEach(function(t){t.getAttribute("data-lang")===e?t.classList.add("lang-btn--active"):t.classList.remove("lang-btn--active")})}async function setLanguage(e){"en"!==e&&"de"!==e&&"es"!==e&&(e="en"),selectedLanguage=e,updateLanguageButtons(e),await BeatifyI18n.setLanguage(e),BeatifyI18n.initPageTranslations()}function setupTimerSelector(){document.querySelectorAll(".timer-btn").forEach(function(e){e.addEventListener("click",function(){var t=parseInt(e.getAttribute("data-duration"),10);t&&t!==selectedDuration&&setTimerDuration(t)})})}function updateTimerButtons(e){document.querySelectorAll(".timer-btn").forEach(function(t){parseInt(t.getAttribute("data-duration"),10)===e?t.classList.add("timer-btn--active"):t.classList.remove("timer-btn--active")})}function setTimerDuration(e){("number"!=typeof e||e<10||e>60)&&(e=30),selectedDuration=e,updateTimerButtons(e)}const difficultyDescriptions={easy:"admin.difficultyEasyDesc",normal:"admin.difficultyNormalDesc",hard:"admin.difficultyHardDesc"};function setupDifficultySelector(){document.querySelectorAll(".difficulty-btn").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-difficulty");t&&t!==selectedDifficulty&&setDifficulty(t)})})}function updateDifficultyButtons(e){document.querySelectorAll(".difficulty-btn").forEach(function(t){t.getAttribute("data-difficulty")===e?t.classList.add("difficulty-btn--active"):t.classList.remove("difficulty-btn--active")})}function setDifficulty(e){-1===["easy","normal","hard"].indexOf(e)&&(e="normal"),selectedDifficulty=e,updateDifficultyButtons(e);var t=document.getElementById("difficulty-description");if(t){var a=difficultyDescriptions[e];t.setAttribute("data-i18n",a),"undefined"!=typeof BeatifyI18n&&BeatifyI18n.t&&(t.textContent=BeatifyI18n.t(a))}}function updateLobbyDifficultyBadge(e){var t=document.getElementById("lobby-difficulty-badge");if(t){var a={easy:"game.difficultyEasy",normal:"game.difficultyNormal",hard:"game.difficultyHard"}[e]||"game.difficultyNormal",n=utils.t(a);t.textContent=n,t.className="difficulty-badge difficulty-badge--"+(e||"normal")}}function setupArtistChallengeToggle(){var e=document.getElementById("artist-challenge-toggle");if(e){var t=localStorage.getItem("beatify_artist_challenge");null!==t&&(artistChallengeEnabled="true"===t,e.checked=artistChallengeEnabled),e.addEventListener("change",function(){artistChallengeEnabled=e.checked,localStorage.setItem("beatify_artist_challenge",artistChallengeEnabled.toString())})}}function setupProviderSelector(){document.querySelectorAll(".provider-btn").forEach(function(e){e.addEventListener("click",function(){if(!e.classList.contains("provider-btn--disabled")){var t=e.getAttribute("data-provider");t&&t!==selectedProvider&&setProvider(t)}})})}function updateProviderButtons(e){document.querySelectorAll(".provider-btn").forEach(function(t){t.getAttribute("data-provider")===e?t.classList.add("provider-btn--active"):t.classList.remove("provider-btn--active")})}function setProvider(e){selectedProvider="spotify",updateProviderButtons("spotify"),playlistData.length>0&&renderPlaylists(playlistData,"")}function renderLobbyPlayers(e){var t=document.getElementById("lobby-players"),a=document.getElementById("lobby-player-count"),n=document.getElementById("admin-players-summary"),s=document.getElementById("lobby-players-empty");if(t){if(e=e||[],a&&(a.textContent=e.length),n&&(n.textContent=e.length),0===e.length)return t.innerHTML="",s&&s.classList.remove("hidden"),void(previousLobbyPlayers=[]);s&&s.classList.add("hidden");var i=e.slice().sort(function(e,t){return e.connected!==t.connected?e.connected?-1:1:0}),l=previousLobbyPlayers.map(function(e){return e.name}),o=i.filter(function(e){return-1===l.indexOf(e.name)}).map(function(e){return e.name});t.innerHTML=i.map(function(e){var t=-1!==o.indexOf(e.name),a=!1===e.connected,n=!0===e.is_admin,s=["player-card",t?"is-new":"",a?"player-card--disconnected":""].filter(Boolean).join(" "),i=n?'<span class="admin-badge">üëë</span>':"",l=a?'<span class="away-badge">'+utils.t("lobby.away","away")+"</span>":"";return'<div class="'+s+'" data-player="'+utils.escapeHtml(e.name)+'"><span class="player-name">'+utils.escapeHtml(e.name)+i+"</span>"+l+"</div>"}).join(""),setTimeout(function(){for(var e=t.querySelectorAll(".is-new"),a=0;a<e.length;a++)e[a].classList.remove("is-new")},2e3),previousLobbyPlayers=e.slice()}}function startLobbyPolling(){stopLobbyPolling(),lobbyPollingInterval=setInterval(async function(){if("lobby"===currentView)try{var e=await fetch("/beatify/api/status");if(!e.ok)return;var t=await e.json();t.active_game&&t.active_game.players&&renderLobbyPlayers(t.active_game.players)}catch(e){console.error("Lobby polling error:",e)}else stopLobbyPolling()},3e3)}function stopLobbyPolling(){lobbyPollingInterval&&(clearInterval(lobbyPollingInterval),lobbyPollingInterval=null)}function setupPlaylistRequests(){const e=document.getElementById("request-modal"),t=document.getElementById("request-success-modal"),a=document.getElementById("spotify-url-input"),n=document.getElementById("spotify-url-error"),s=document.getElementById("request-submit-btn");function i(){e?.classList.add("hidden"),a&&(a.value="",a.classList.remove("input-error")),n?.classList.add("hidden"),s&&(s.disabled=!0,s.classList.remove("btn--loading"))}document.getElementById("request-playlist-btn")?.addEventListener("click",()=>{e&&(e.classList.remove("hidden"),a?.focus())}),document.getElementById("request-cancel-btn")?.addEventListener("click",()=>{i()}),e?.querySelector(".modal-backdrop")?.addEventListener("click",()=>{i()}),a?.addEventListener("input",()=>{const e=a.value.trim(),t=window.PlaylistRequests?.isValidSpotifyUrl(e);e&&!t?(a.classList.add("input-error"),n?.classList.remove("hidden")):(a.classList.remove("input-error"),n?.classList.add("hidden")),s&&(s.disabled=!t)}),s?.addEventListener("click",async()=>{const e=a?.value.trim();if(e&&window.PlaylistRequests?.isValidSpotifyUrl(e)){s.classList.add("btn--loading"),s.disabled=!0;try{const a=await window.PlaylistRequests.submitRequest(e);i();const n=document.getElementById("request-success-name");n&&(n.textContent=a.playlist_name),t?.classList.remove("hidden"),await renderRequestsList()}catch(e){console.error("Failed to submit request:",e),a?.classList.add("input-error"),n&&(n.textContent=e.message||"Failed to submit request",n.classList.remove("hidden"))}finally{s.classList.remove("btn--loading");const e=window.PlaylistRequests?.isValidSpotifyUrl(a?.value.trim()||"");s.disabled=!e}}}),document.getElementById("request-success-close-btn")?.addEventListener("click",()=>{t?.classList.add("hidden")}),t?.querySelector(".modal-backdrop")?.addEventListener("click",()=>{t?.classList.add("hidden")})}async function initPlaylistRequests(){if(await renderRequestsList(),window.PlaylistRequests)try{await window.PlaylistRequests.pollStatuses()&&await renderRequestsList()}catch(e){console.error("Failed to poll request statuses:",e)}}async function renderRequestsList(){const e=document.getElementById("my-requests"),t=document.getElementById("my-requests-list"),a=document.getElementById("my-requests-empty"),n=document.getElementById("my-requests-summary");if(!window.PlaylistRequests)return void e?.classList.add("hidden");"setup"===currentView&&e?.classList.remove("hidden");const s=await window.PlaylistRequests.getRequestsForDisplayAsync();n&&(n.textContent=s.length.toString()),0===s.length?(t.innerHTML="",a?.classList.remove("hidden")):(a?.classList.add("hidden"),t.innerHTML=s.map(e=>{const t=`request-status--${e.status}`,a={pending:"‚è≥ Pending",ready:"‚úÖ Ready",installed:"‚úì Installed",declined:"‚ùå Declined"}[e.status]||e.status,n=e.thumbnail_url?`<img class="request-item-thumbnail" src="${e.thumbnail_url}" alt="">`:'<div class="request-item-thumbnail-placeholder">üéµ</div>';let s="";return"ready"===e.status&&e.update_available&&(s=`<a href="https://github.com/mholzi/beatify/releases" target="_blank"\n                    class="btn btn-primary request-update-btn">Update to v${e.release_version}</a>`),`\n                <div class="request-item">\n                    ${n}\n                    <div class="request-item-info">\n                        <div class="request-item-name">${escapeHtml(e.playlist_name)}</div>\n                        <div class="request-item-meta">${e.relative_time}</div>\n                    </div>\n                    <span class="request-status ${t}">${a}</span>\n                    ${s}\n                </div>\n            `}).join(""))}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/beatify/static/sw.js",{scope:"/beatify/"}).then(function(e){console.log("[Admin] SW registered:",e.scope)}).catch(function(e){console.warn("[Admin] SW registration failed:",e)})});
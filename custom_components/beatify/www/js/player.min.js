!function(){"use strict";var e=window.BeatifyUtils||{};const n=new URLSearchParams(window.location.search).get("game"),a=document.getElementById("loading-view"),i=document.getElementById("not-found-view"),s=document.getElementById("ended-view"),o=document.getElementById("in-progress-view"),r=document.getElementById("join-view"),l=document.getElementById("lobby-view"),d=document.getElementById("game-view"),c=document.getElementById("reveal-view"),u=document.getElementById("paused-view"),m=document.getElementById("end-view"),v=document.getElementById("connection-lost-view"),f=[a,i,s,o,r,l,d,c,u,m,v];function g(t){e.showView(f,t)}function p(t,n,a,i){return new Promise(function(s){var o=document.getElementById("confirm-modal"),r=document.getElementById("confirm-modal-title"),l=document.getElementById("confirm-modal-message"),d=document.getElementById("confirm-modal-yes"),c=document.getElementById("confirm-modal-no");if(o&&r&&l&&d&&c){r.textContent=t,l.textContent=n,d.textContent=a||e.t("common.confirm")||"Confirm",c.textContent=i||e.t("common.cancel")||"Cancel",o.classList.remove("hidden");var u=o.querySelector(".modal-backdrop");d.addEventListener("click",v),c.addEventListener("click",f),u&&u.addEventListener("click",f)}else s(confirm(n||t));function m(){o.classList.add("hidden"),d.removeEventListener("click",v),c.removeEventListener("click",f),u.removeEventListener("click",f)}function v(){m(),s(!0)}function f(){m(),s(!1)}})}async function y(){var e;if(n)if((e=n)&&"string"==typeof e&&/^[a-zA-Z0-9_-]{8,16}$/.test(e))try{const e=await fetch(`/beatify/api/game-status?game=${encodeURIComponent(n)}`),t=await e.json();if(!t.exists)return void g("not-found-view");if("END"===t.phase)return void g("ended-view");if(sessionStorage.getItem("beatify_admin_name"))return;if(h())return void q();t.can_join?g("join-view"):g("in-progress-view")}catch(e){console.error("Failed to check game status:",e),g("not-found-view")}else g("not-found-view");else g("not-found-view")}y(),document.getElementById("refresh-btn")?.addEventListener("click",()=>{g("loading-view"),y()}),document.getElementById("retry-btn")?.addEventListener("click",()=>{g("loading-view"),y()});var b="beatify_session";function h(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){var n=e[t].trim();if(0===n.indexOf(b+"="))return n.substring(b.length+1)}return null}function E(){document.cookie=b+"=; path=/beatify; max-age=0"}function L(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}function I(e){return 1-Math.pow(1-e,4)}function w(e,t,n,a,i){if(L()||t===n)return e.textContent=n,{cancel:function(){},skipToEnd:function(){e.textContent=n}};var s=k.getQualitySettings();if(0===s.scoreDuration)return e.textContent=n,{cancel:function(){},skipToEnd:function(){e.textContent=n}};var o=Math.min(a,s.scoreDuration||a);i=i||I;var r=null,l=null,d=!1,c=n;return l=requestAnimationFrame(function n(a){if(!d){r||(r=a);var s=a-r,u=Math.min(s/o,1),m=i(u),v=Math.round(t+(c-t)*m);e.textContent=v,u<1&&(l=requestAnimationFrame(n))}}),{cancel:function(){d=!0,l&&cancelAnimationFrame(l)},skipToEnd:function(){d=!0,l&&cancelAnimationFrame(l),e.textContent=c}}}function B(e,t,n){if(n=n||{},!L()){var a=document.createElement("div");a.className="points-popup",a.textContent=n.text||"+"+t,n.isStreak?a.classList.add("points-popup--streak"):n.isBetWin&&a.classList.add("points-popup--gold");var i=e.getBoundingClientRect();a.style.left=i.left+i.width/2+"px",a.style.top=i.top+"px",document.body.appendChild(a),a.addEventListener("animationend",function(){a.parentNode&&a.parentNode.removeChild(a)}),setTimeout(function(){a.parentNode&&a.parentNode.removeChild(a)},1200)}}var _={players:{},leaderboard:[],initialized:!1};var S=[3,5,10,15,20,25],k=function(){var e=window.matchMedia("(prefers-reduced-motion: reduce)"),t=e.matches;e.addEventListener("change",function(e){t=e.matches});var n=null;function a(){if(null!==n)return n;var e=navigator.hardwareConcurrency||2,t=navigator.deviceMemory||4,a=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;return n=e<=2||t<=2?"low":e<=4||t<=4||a?"medium":"high"}return a(),{prefersReducedMotion:function(){return t},getDeviceTier:a,getQualitySettings:function(){var e=a();if(t)return{confettiParticles:0,scoreDuration:0,leaderboardAnimation:"none",neonGlow:!1,enableAnimations:!1};switch(e){case"low":return{confettiParticles:5,scoreDuration:0,leaderboardAnimation:"none",neonGlow:!1,enableAnimations:!0};case"medium":return{confettiParticles:10,scoreDuration:300,leaderboardAnimation:"simplified",neonGlow:!1,enableAnimations:!0};default:return{confettiParticles:15,scoreDuration:500,leaderboardAnimation:"full",neonGlow:!0,enableAnimations:!0}}},ifMotionAllowed:function(e,n){t?n&&n():e()},withWillChange:function(e,t,n){e&&(e.style.willChange=t,setTimeout(function(){e&&e.style&&(e.style.willChange="auto")},(n||500)+100))}}}(),x=function(){var e=[],t=!1,n=null,a=null;function i(){if(a&&(clearTimeout(a),a=null),0===e.length)return t=!1,void(n=null);n=e.shift(),a=setTimeout(function(){n&&n.skipToEnd&&n.skipToEnd(),i()},2e3),n.run(function(){a&&(clearTimeout(a),a=null),i()})}return{add:function(n){e.push(n),t||(t=!0,i())},skipAll:function(){a&&(clearTimeout(a),a=null),n&&n.skipToEnd&&n.skipToEnd(),e.forEach(function(e){e.skipToEnd&&e.skipToEnd()}),e=[],t=!1,n=null},clear:function(){a&&(clearTimeout(a),a=null),e=[],t=!1,n=null},isRunning:function(){return t},getMaxDuration:function(){return maxDuration}}}(),C={VISIBLE_BUFFER:2,ENTRY_HEIGHT:48,MIN_PLAYERS_FOR_LAZY:10,ROOT_MARGIN:"96px 0px",DEFAULT_VIEWPORT_HEIGHT:280},T={observer:null,fullData:[],visibleRange:{start:0,end:10},listEl:null,isLazyEnabled:!1};function N(){var e=T.listEl,t=T.fullData,n=T.visibleRange;if(e&&t.length){var a=C.ENTRY_HEIGHT,i=n.start*a,s=(t.length-n.end)*a,o=e.scrollTop,r="";i>0&&(r+='<div class="leaderboard-spacer-top" style="height: '+i+'px;"></div>'),r+='<div class="leaderboard-sentinel leaderboard-sentinel--top" style="height: 1px;"></div>';for(var l=n.start;l<n.end&&l<t.length;l++)r+=M(t[l]);if(r+='<div class="leaderboard-sentinel leaderboard-sentinel--bottom" style="height: 1px;"></div>',s>0&&(r+='<div class="leaderboard-spacer-bottom" style="height: '+s+'px;"></div>'),e.innerHTML=r,e.scrollTop=o,T.observer)e.querySelectorAll(".leaderboard-sentinel").forEach(function(e){T.observer.observe(e)})}}function M(e){if(!e)return"";if(e.separator)return'<div class="leaderboard-separator">...</div>';var t=e.name||"Unknown",n=e.rank||0,a=e.score||0,i=n<=3?"is-top-"+n:"",s=e.is_current?"is-current":"",o="";e.rank_change>0||"up"===e._rankChange?o="leaderboard-entry--climbing leaderboard-entry--slide-up":(e.rank_change<0||"down"===e._rankChange)&&(o="leaderboard-entry--falling leaderboard-entry--slide-down");var r="";e.rank_change>0?r='<span class="rank-up">‚ñ≤'+e.rank_change+"</span>":e.rank_change<0&&(r='<span class="rank-down">‚ñº'+Math.abs(e.rank_change)+"</span>");var l="";e.streak>=2&&(l='<span class="streak-indicator '+(e.streak>=5?"streak-indicator--hot":"")+'">üî•'+e.streak+"</span>");var d=!1===e.connected?"leaderboard-entry--disconnected":"",c=!1===e.connected?'<span class="away-badge">(away)</span>':"",u=void 0!==e._displayScore?e._displayScore:a;return'<div class="leaderboard-entry '+i+" "+s+" "+o+" "+d+'" data-rank="'+n+'" data-name="'+G(t)+'"><span class="entry-rank">#'+n+'</span><span class="entry-name">'+G(t)+c+'</span><span class="entry-meta">'+l+r+'</span><span class="entry-score" data-prev-score="'+(e._prevScore||a)+'">'+u+"</span></div>"}function A(e,t){for(var n,a,i=C,s=T.listEl&&T.listEl.clientHeight||i.DEFAULT_VIEWPORT_HEIGHT,o=Math.ceil(s/i.ENTRY_HEIGHT),r=i.VISIBLE_BUFFER,l=-1,d=0;d<e.length;d++)if(e[d].name===t){l=d;break}return-1===l||l<o?(n=0,a=Math.min(e.length,o+2*r)):l>=e.length-o?(n=Math.max(0,e.length-o-r),a=e.length):(n=Math.max(0,l-Math.floor(o/2)-r),a=Math.min(e.length,l+Math.ceil(o/2)+r)),{start:n,end:a}}var O={ITEM_HEIGHT:60,OVERSCAN:3,THRESHOLD:15,CONTAINER_HEIGHT:320},R={container:null,items:[],scrollTop:0,isVirtual:!1,topSpacer:null,bottomSpacer:null,contentWrapper:null,scrollHandler:null,resizeHandler:null};function H(e,t){R.items=e,R.renderItem=t;var n=R.container;if(n){var a=n.scrollTop,i=R.isVirtual;e.length<O.THRESHOLD?(R.isVirtual=!1,n.classList.remove("player-list--virtual"),function(e,t){var n=R.container;if(!n)return;for(var a="",i=0;i<e.length;i++)a+=t(e[i],i);n.innerHTML=a}(e,t)):(R.isVirtual=!0,n.classList.add("player-list--virtual"),function(){var e=R.container;if(!e)return;e.innerHTML="";var t=document.createElement("div");t.className="virtual-spacer-top",R.topSpacer=t;var n=document.createElement("div");n.className="virtual-content-wrapper",R.contentWrapper=n;var a=document.createElement("div");a.className="virtual-spacer-bottom",R.bottomSpacer=a,e.appendChild(t),e.appendChild(n),e.appendChild(a)}(),D()),i!==R.isVirtual&&a>0&&(n.scrollTop=a,R.scrollTop=a)}}function D(){var e=O,t=R.items,n=R.container,a=R.contentWrapper;if(n&&a&&t.length){var i=n.clientHeight||e.CONTAINER_HEIGHT,s=R.scrollTop,o=e.ITEM_HEIGHT,r=e.OVERSCAN,l=Math.max(0,Math.floor(s/o)-r),d=Math.min(t.length,Math.ceil((s+i)/o)+r);R.topSpacer&&(R.topSpacer.style.height=l*o+"px"),R.bottomSpacer&&(R.bottomSpacer.style.height=(t.length-d)*o+"px");for(var c="",u=l;u<d;u++)c+=R.renderItem(t[u],u);a.innerHTML=c}}function q(){var e,t=h();if(!t||(!(e=t)||"string"!=typeof e||!/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(e)&&!/^[a-f0-9]{32}$/i.test(e)))return t&&E(),void g("join-view");var n=("https:"===window.location.protocol?"wss:":"ws:")+"//"+window.location.host+"/beatify/ws";et=new WebSocket(n),et.onopen=function(){nt=0,lt=!1,gt(),et.send(JSON.stringify({type:"reconnect",session_id:t}))},et.onmessage=function(e){try{ht(JSON.parse(e.data))}catch(e){console.error("Failed to parse WebSocket message:",e)}},et.onclose=function(){if(tt&&nt<at){lt=!0,nt++,ft(),pt(nt);var e=ut();console.log("WebSocket closed. Reconnecting in "+e+"ms... (attempt "+nt+")"),setTimeout(function(){q()},e)}else nt>=at?(lt=!1,gt(),yt()):g("join-view")},et.onerror=function(e){console.error("WebSocket error:",e)}}let W=[];function G(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function F(n){const a=document.getElementById("player-list"),i=document.getElementById("player-count"),s=document.getElementById("player-count-badge"),o=document.getElementById("players-summary"),r=document.getElementById("players-empty");if(!a)return;n&&Array.isArray(n)||(n=[]);const l=n.length;i&&(i.textContent=1===l?e.t("lobby.playerJoined"):t("lobby.playersJoined",{count:l})),s&&(s.textContent=l),o&&(o.textContent=l),r&&r.classList.toggle("hidden",l>0);var d=n.slice().sort(function(e,t){return e.connected!==t.connected?e.connected?-1:1:0});const c=W.map(function(e){return e.name}),u=d.filter(function(e){return-1===c.indexOf(e.name)}).map(function(e){return e.name});R.container||function(e){if(e){R.container=e;var t,n=!1;R.scrollHandler=function(){R.scrollTop=e.scrollTop,n||(requestAnimationFrame(function(){D(),n=!1}),n=!0)},R.resizeHandler=function(){clearTimeout(t),t=setTimeout(function(){R.isVirtual&&D()},100)},e.addEventListener("scroll",R.scrollHandler,{passive:!0}),window.addEventListener("resize",R.resizeHandler)}}(a);H(d,function(t){var n=-1!==u.indexOf(t.name),a=t.name===tt,i=!1===t.connected,s=i?'<span class="away-badge">(away)</span>':"";return'<div class="'+["player-card",n?"is-new":"",a?"player-card--you":"",i?"player-card--disconnected":""].filter(Boolean).join(" ")+'" data-player="'+G(t.name)+'"><span class="player-name">'+G(t.name)+(a?'<span class="you-badge">'+e.t("leaderboard.you")+"</span>":"")+s+"</span></div>"}),setTimeout(function(){var e=R.isVirtual?R.contentWrapper:a;if(!e)return;const t=e.querySelectorAll(".is-new");for(let e=0;e<t.length;e++)t[e].classList.remove("is-new")},2e3),W=n.slice()}function j(e){var n=t({easy:"game.difficultyEasy",normal:"game.difficultyNormal",hard:"game.difficultyHard"}[e]||"game.difficultyNormal"),a=document.getElementById("lobby-difficulty-badge"),i=document.getElementById("game-difficulty-badge");a&&(a.textContent=n,a.className="difficulty-badge difficulty-badge--"+(e||"normal")),i&&(i.textContent=n,i.className="difficulty-badge difficulty-badge--"+(e||"normal"))}let P=null;function z(){if(P){var e=document.getElementById("qr-modal"),t=document.getElementById("qr-modal-code");if(e&&t){t.innerHTML="","undefined"!=typeof QRCode?new QRCode(t,{text:P,width:256,height:256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):t.innerHTML='<p class="status-error">QR code library not loaded</p>',e.classList.remove("hidden"),document.body.style.overflow="hidden";var n=document.getElementById("qr-modal-close");n&&n.focus()}}}function U(){var e=document.getElementById("qr-modal");e&&(e.classList.add("hidden"),document.body.style.overflow="")}function V(){if(P){var e=document.getElementById("invite-modal"),t=document.getElementById("invite-modal-code"),n=document.getElementById("invite-modal-url");if(e&&t){t.innerHTML="","undefined"!=typeof QRCode?new QRCode(t,{text:P,width:256,height:256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):t.innerHTML='<p class="status-error">QR code library not loaded</p>',n&&(n.value=P),e.classList.remove("hidden"),document.body.style.overflow="hidden";var a=document.getElementById("invite-modal-close");a&&a.focus()}}}function J(){var e=document.getElementById("invite-modal");e&&(e.classList.add("hidden"),document.body.style.overflow="");var t=document.getElementById("invite-copy-feedback");t&&t.classList.add("hidden")}function Y(){var e=document.getElementById("invite-modal-url"),t=document.getElementById("invite-copy-feedback");e&&P&&(navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(P).then(function(){$(t)}).catch(function(){Q(e,t)}):Q(e,t))}function Q(e,t){e.select(),e.setSelectionRange(0,99999);try{document.execCommand("copy"),$(t)}catch(e){console.warn("[Beatify] Copy failed:",e)}}function $(e){e&&(e.classList.remove("hidden"),setTimeout(function(){e.classList.add("hidden")},2e3))}let Z=null;function K(){Z&&(clearInterval(Z),Z=null)}function X(t){var n=document.getElementById("current-round"),a=document.getElementById("total-rounds"),i=document.getElementById("last-round-banner");n&&(n.textContent=t.round||1),a&&(a.textContent=t.total_rounds||10),i&&(t.last_round?i.classList.remove("hidden"):i.classList.add("hidden"));var s=document.getElementById("intro-badge"),o=document.getElementById("intro-splash");if(s)if(t.is_intro_round){s.classList.remove("hidden");var r=s.querySelector("[data-i18n]");t.intro_stopped?(s.classList.add("intro-badge--stopped"),r&&(r.setAttribute("data-i18n","game.introStopped"),r.textContent=e.t("game.introStopped")||"Intro complete!")):(s.classList.remove("intro-badge--stopped"),r&&(r.setAttribute("data-i18n","game.introRound"),r.textContent=e.t("game.introRound")||"INTRO ROUND"),o&&!o._shown&&(o._shown=!0,o.classList.remove("hidden"),setTimeout(function(){o.classList.add("hidden")},2e3)))}else s.classList.add("hidden"),s.classList.remove("intro-badge--stopped"),o&&(o.classList.add("hidden"),o._shown=!1);var l=document.getElementById("album-cover"),d=document.getElementById("album-loading");if(l&&t.song){d&&d.classList.remove("hidden");var c=t.song.album_art||"/beatify/static/img/no-artwork.svg";l.onload=function(){d&&d.classList.add("hidden")},l.onerror=function(){l.src="/beatify/static/img/no-artwork.svg",d&&d.classList.add("hidden")},l.src=c}!function(e){var t=document.getElementById("submission-tracker"),n=document.getElementById("submitted-players");if(!t||!n)return;var a=e||[],i=a.filter(function(e){return e.submitted}).length,s=a.length,o=i===s&&s>0;t.classList.toggle("all-submitted",o),n.innerHTML=a.map(function(e){var t=function(e){if(!e)return"?";var t=e.trim();if(!t)return"?";var n=t.split(/[\s-]+/).filter(Boolean);if(n.length>=2)return(n[0][0]+n[1][0]).toUpperCase();return t.slice(0,Math.min(2,t.length)).toUpperCase()}(e.name),n=e.name===tt,a=!1===e.connected,i=["player-indicator",e.submitted?"is-submitted":"",n?"is-current-player":"",a?"player-indicator--disconnected":""].filter(Boolean).join(" "),s="";return e.steal_used&&(s+='<span class="player-badge player-badge--steal">ü•∑</span>'),e.bet&&(s+='<span class="player-badge player-badge--bet">üé≤</span>'),'<div class="'+i+'">'+s+'<div class="player-avatar"><span class="player-initials">'+G(t)+'</span></div><span class="player-name">'+G(e.name)+"</span></div>"}).join("")}(t.players),t.leaderboard&&ee(t,"leaderboard-list"),function(e){if(!tt||!e)return;var t=e.find(function(e){return e.name===tt});if(!t)return;ie=t.steal_available&&!te;var n=document.getElementById("steal-indicator"),a=document.getElementById("steal-btn");ie?(n&&n.classList.remove("hidden"),a&&a.classList.remove("hidden")):Ie()}(t.players),void 0!==t.artist_challenge&&function(t){var n=document.getElementById("artist-challenge-container");if(!n)return;if(!t||!t.options)return void n.classList.add("hidden");n.classList.remove("hidden");var a=document.getElementById("artist-options"),i=document.getElementById("artist-result"),s=Array.from(a.querySelectorAll(".artist-option-btn")).map(function(e){return e.dataset.artist}),o=t.options;JSON.stringify(s)!==JSON.stringify(o)&&(a.innerHTML="",o.forEach(function(e,t){var n=document.createElement("button");n.className="artist-option-btn",n.dataset.artist=e,n.dataset.index=t,n.textContent=e,n.addEventListener("click",function(){!function(e){var t=Date.now();if(t-de<le)return;if(de=t,se)return;var n=document.querySelector('.artist-option-btn[data-artist="'+CSS.escape(e)+'"]');n&&n.classList.add("is-loading");oe=e;try{et&&et.readyState===WebSocket.OPEN&&et.send(JSON.stringify({type:"artist_guess",artist:e}))}catch(e){console.error("Artist guess send failed:",e),n&&n.classList.remove("is-loading"),oe=null}}(e)}),a.appendChild(n)}));if(t.winner){if(a.querySelectorAll(".artist-option-btn").forEach(function(e){e.classList.add("is-disabled"),e.classList.remove("is-loading","is-wrong");var n=t.correct_artist||re;n&&e.dataset.artist===n&&e.classList.add("is-winner")}),t.winner===tt){var r=t.bonus_points||5;i.textContent=(e.t("artistChallenge.youGotIt")||"You got it! +{points} points").replace("{points}",r),i.className="artist-result is-winner"}else{var l=(e.t("artistChallenge.someoneBeatYou")||"{winner} got it first!").replace("{winner}",t.winner);i.textContent=l,i.className="artist-result is-late"}i.classList.remove("hidden"),se=!0}else se||i.classList.add("hidden")}(t.artist_challenge),void 0!==t.movie_challenge&&function(e){var t=document.getElementById("movie-challenge-container");if(!t)return;if(!e||!e.options)return void t.classList.add("hidden");t.classList.remove("hidden");var n=document.getElementById("movie-options"),a=(document.getElementById("movie-result"),Array.from(n.querySelectorAll(".movie-option-btn")).map(function(e){return e.dataset.movie})),i=e.options;JSON.stringify(a)!==JSON.stringify(i)&&(n.innerHTML="",i.forEach(function(e,t){var a=document.createElement("button");a.className="movie-option-btn",a.dataset.movie=e,a.dataset.index=t,a.textContent=e,a.addEventListener("click",function(){!function(e){var t=Date.now();if(t-ve<me)return;if(ve=t,ce)return;var n=document.querySelector('.movie-option-btn[data-movie="'+CSS.escape(e)+'"]');n&&n.classList.add("is-loading");ue=e;try{et&&et.readyState===WebSocket.OPEN&&et.send(JSON.stringify({type:"movie_guess",movie:e}))}catch(e){console.error("Movie guess send failed:",e),n&&n.classList.remove("is-loading"),ue=null}}(e)}),n.appendChild(a)}));if(ce){n.querySelectorAll(".movie-option-btn").forEach(function(e){e.classList.add("is-disabled")})}}(t.movie_challenge)}function ee(t,n,a){var i=t.leaderboard||[],s=document.getElementById(n||"leaderboard-list");if(s){var o,r,l=a&&_.initialized,d=l?(o=i.map(function(e){return e.name}),r={},o.forEach(function(e,t){var n=_.leaderboard.indexOf(e);-1===n?r[e]="new":t<n?r[e]="up":t>n&&(r[e]="down")}),r):{};i.forEach(function(e){e.is_current=e.name===tt;var t=d[e.name];t&&(e._rankChange=t);var n=_.players[e.name],i=n?n.score:e.score;e._prevScore=i,e._displayScore=a?i:e.score});var c=function(e,t){if(e.length<=10)return e;for(var n=e.slice(0,5),a=e.slice(-3),i=-1,s=0;s<e.length;s++)if(e[s].name===t){i=s;break}if(i<5||i>=e.length-3)return[].concat(n,[{separator:!0}],a);return[].concat(n,[{separator:!0}],[e[i]],[{separator:!0}],a)}(i,tt);if(i.length>=C.MIN_PLAYERS_FOR_LAZY)T.observer||function(e){e&&(T.observer&&T.listEl!==e&&(T.observer.disconnect(),T.observer=null),T.observer||(T.listEl=e,T.observer=new IntersectionObserver(function(e){e.forEach(function(e){if(e.isIntersecting&&T.isLazyEnabled){var t=T.fullData,n=T.visibleRange,a=C.VISIBLE_BUFFER;if(e.target.classList.contains("leaderboard-sentinel--top")){if(n.start>0){var i=Math.max(0,n.start-a);T.visibleRange.start=i,N()}}else if(e.target.classList.contains("leaderboard-sentinel--bottom")&&n.end<t.length){var s=Math.min(t.length,n.end+a);T.visibleRange.end=s,N()}}})},{root:e,rootMargin:C.ROOT_MARGIN,threshold:0})))}(s),T.fullData=c,T.isLazyEnabled=!0,T.listEl=s,T.visibleRange=A(c,tt),N();else{T.isLazyEnabled=!1;var u="";c.forEach(function(e){u+=M(e)}),s.innerHTML=u}var m=[];l&&c.forEach(function(e){e.separator||e._prevScore===e.score||m.push({name:e.name,prevScore:e._prevScore,newScore:e.score})}),l&&m.length>0&&requestAnimationFrame(function(){for(var e={},t=s.querySelectorAll(".leaderboard-entry[data-name]"),n=0;n<t.length;n++){var a=t[n],i=a.getAttribute("data-name");i&&(e[i]=a)}m.forEach(function(t){var n=e[t.name];if(n){var a=n.querySelector(".entry-score");a&&w(a,t.prevScore,t.newScore,500)}})}),i.length>8&&function(e){var t=e.querySelector(".leaderboard-entry.is-current");t&&t.scrollIntoView({behavior:"smooth",block:"center"})}(s),function(t){var n=document.getElementById("leaderboard-you"),a=t.find(function(e){return e.is_current});n&&a&&(n.textContent=e.t("leaderboard.you")+" #"+a.rank,n.classList.remove("hidden"))}(i),function(e,t){(t?[t]:["leaderboard-summary","reveal-leaderboard-summary"]).forEach(function(t){var n=document.getElementById(t);if(n&&e&&0!==e.length){var a=e[0];a&&(n.textContent=a.name+": "+a.score)}})}(i),function(e,t){_.players={},e.forEach(function(e){_.players[e.name]={score:e.score,rank:e.rank||0,streak:e.streak||0}}),t&&(_.leaderboard=t.map(function(e){return e.name})),_.initialized=!0}(t.players||[],i)}}let te=!1,ne=!1,ae=0,ie=!1;var se=!1,oe=null,re=null,le=300,de=0,ce=!1,ue=null,me=500,ve=0;function fe(){if(!te){var e=document.getElementById("year-slider"),t=document.getElementById("submit-btn");if(e&&t){var n=parseInt(e.value,10);t.disabled=!0,t.classList.add("is-loading"),et&&et.readyState===WebSocket.OPEN?et.send(JSON.stringify({type:"submit",year:n,bet:ne})):(pe("Connection lost. Please refresh."),t.disabled=!1,t.classList.remove("is-loading"))}}}function ge(){te=!0;var e=document.getElementById("year-selector"),t=document.getElementById("submit-btn"),n=document.getElementById("submitted-confirmation"),a=document.getElementById("bet-toggle");e&&e.classList.add("is-submitted"),t&&t.classList.add("hidden"),a&&a.classList.add("hidden"),n&&n.classList.remove("hidden")}function pe(t){var n=document.getElementById("submit-btn");n&&(n.textContent=t,n.classList.add("is-error"),setTimeout(function(){n.textContent=e.t("game.submitGuess"),n.classList.remove("is-error")},2e3))}function ye(){te=!1,ne=!1;var t=document.getElementById("year-selector"),n=document.getElementById("submit-btn"),a=document.getElementById("submitted-confirmation"),i=document.getElementById("year-slider"),s=document.getElementById("bet-toggle");if(t&&t.classList.remove("is-submitted"),n&&(n.disabled=!1,n.classList.remove("hidden","is-loading","is-error"),n.textContent=e.t("game.submitGuess")),s&&s.classList.remove("hidden","is-active"),a&&a.classList.add("hidden"),i){i.value=1990;var o=document.getElementById("selected-year");o&&(o.textContent="1990")}ie=!1,Ie(),function(){se=!1,oe=null,re=null;var e=document.getElementById("artist-challenge-container");e&&e.classList.add("hidden");var t=document.getElementById("artist-options");t&&(t.innerHTML="");var n=document.getElementById("artist-result");n&&(n.classList.add("hidden"),n.className="artist-result hidden")}(),function(){ce=!1,ue=null;var e=document.getElementById("movie-challenge-container");e&&e.classList.add("hidden");var t=document.getElementById("movie-options");t&&(t.innerHTML="");var n=document.getElementById("movie-result");n&&(n.classList.add("hidden"),n.className="movie-result hidden")}()}function be(){document.querySelectorAll(".artist-option-btn").forEach(function(e){e.classList.add("is-disabled"),e.classList.remove("is-loading")})}function he(e,t){var n=document.getElementById("artist-result");n&&(n.textContent=e,n.className="artist-result "+(t?"is-winner":"is-late"),n.classList.remove("hidden"))}function Ee(){document.querySelectorAll(".movie-option-btn").forEach(function(e){e.classList.add("is-disabled"),e.classList.remove("is-loading")})}function Le(e,t){var n=document.getElementById("movie-result");n&&(n.textContent=e,n.className="movie-result "+(t?"is-winner":"is-late"),n.classList.remove("hidden"))}function Ie(){var e=document.getElementById("steal-indicator"),t=document.getElementById("steal-btn");e&&e.classList.add("hidden"),t&&t.classList.add("hidden")}function we(){ie&&!te&&et&&et.readyState===WebSocket.OPEN&&et.send(JSON.stringify({type:"get_steal_targets"}))}function Be(t){var n=document.getElementById("steal-modal"),a=document.getElementById("steal-target-list");if(n&&a){if(a.innerHTML="",t&&0!==t.length)t.forEach(function(t){var n=document.createElement("button");n.className="steal-target-btn",n.textContent=t,n.addEventListener("click",function(){!async function(t){var n=e.t("steal.confirm").replace("{name}",t);if(!await p(e.t("steal.confirmTitle")||"Steal Answer?",n,e.t("steal.confirmButton")||"Steal",e.t("common.cancel")))return;et&&et.readyState===WebSocket.OPEN&&et.send(JSON.stringify({type:"steal",target:t}));_e()}(t)}),a.appendChild(n)});else{var i=document.createElement("p");i.className="steal-no-targets",i.textContent=e.t("steal.waitForSubmit"),a.appendChild(i)}n.classList.remove("hidden")}}function _e(){var e=document.getElementById("steal-modal");e&&e.classList.add("hidden")}function Se(t){if(t.success){ie=!1,te=!0,Ie();var n=document.getElementById("year-selector"),a=document.getElementById("submit-btn"),i=document.getElementById("submitted-confirmation");n&&n.classList.add("is-submitted"),a&&a.classList.add("hidden"),i&&i.classList.remove("hidden"),function(t,n){var a=document.getElementById("steal-confirmation"),i=document.getElementById("steal-confirmation-text");if(!a||!i)return;var s=e.t("steal.success").replace("{name}",t).replace("{year}",n);i.textContent=s,a.classList.remove("hidden"),setTimeout(function(){a.classList.add("hidden")},3e3)}(t.target,t.year);var s=document.getElementById("selected-year"),o=document.getElementById("year-slider");s&&(s.textContent=t.year),o&&(o.value=t.year)}}function ke(n){var a=n.song||{},i=n.players||[],s=document.getElementById("reveal-round"),o=document.getElementById("reveal-total");s&&(s.textContent=n.round||1),o&&(o.textContent=n.total_rounds||10);var r=document.getElementById("intro-badge");if(r)if(n.is_intro_round){r.classList.remove("hidden"),r.classList.add("intro-badge--stopped");var l=r.querySelector("[data-i18n]");l&&(l.setAttribute("data-i18n","game.introStopped"),l.textContent=e.t("game.introStopped")||"Intro complete!")}else r.classList.add("hidden");var d=document.getElementById("reveal-album-cover");d&&(d.src=a.album_art||"/beatify/static/img/no-artwork.svg");var c=document.getElementById("correct-year");c&&(c.textContent=a.year||"????");var u=document.getElementById("song-title"),m=document.getElementById("song-artist");u&&(u.textContent=a.title||"Unknown Song"),m&&(m.textContent=a.artist||"Unknown Artist");var v=document.getElementById("fun-fact-container"),f=document.getElementById("fun-fact"),g=v?v.querySelector(".fun-fact-header"):null,p=e.getLocalizedSongField(a,"fun_fact");if(f&&(f.textContent=p||""),g&&(g.style.display=p?"flex":"none"),function(t){var n=document.getElementById("song-rich-info");if(!n)return;var a=[],i=function(t){if(!t)return[];var n=[];if(t.billboard_peak&&t.billboard_peak>0){var a=t.weeks_on_chart?' <span class="chart-weeks">¬∑ '+t.weeks_on_chart+" "+e.t("reveal.weeksShort")+"</span>":"";n.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">üìä</span>#'+t.billboard_peak+" "+e.t("reveal.chartBillboard")+a+"</span>")}t.german_peak&&t.german_peak>0&&!t.billboard_peak&&n.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">üìä</span>#'+t.german_peak+" "+e.t("reveal.chartGerman")+"</span>");t.uk_peak&&t.uk_peak>0&&!t.billboard_peak&&n.push('<span class="song-badge song-badge--chart"><span class="song-badge-icon">üìä</span>#'+t.uk_peak+" "+e.t("reveal.chartUK")+"</span>");return n}(t.chart_info||{});i.length>0&&(a=a.concat(i));var s=function(e){if(!e||0===e.length)return[];for(var t=[],n=0;n<e.length;n++){var a=e[n],i=xe(a),s=Ce(a);t.push('<span class="song-badge '+i+'"><span class="song-badge-icon">'+s+"</span>"+G(a)+"</span>")}return t}(t.certifications||[]);s.length>0&&(a=a.concat(s));var o=e.getLocalizedSongField(t,"awards")||[],r=function(e){if(!e||0===e.length)return[];for(var t=[],n=e.slice(0,3),a=0;a<n.length;a++){var i=n[a],s=Te(i),o=Ne(i);t.push('<span class="song-badge '+s+'"><span class="song-badge-icon">'+o+"</span>"+G(i)+"</span>")}e.length>3&&t.push('<span class="song-badges-more">+'+(e.length-3)+" more</span>");return t}(o);r.length>0&&(a=a.concat(r));a.length>0?n.innerHTML='<div class="song-badges-row">'+a.join("")+"</div>":n.innerHTML=""}(a),function(t){var n=document.getElementById("song-difficulty");if(!n)return;if(!t)return void n.classList.add("hidden");for(var a="",i=0;i<t.stars;i++)a+='<span class="star">&#9733;</span>';n.innerHTML='<div class="difficulty-stars difficulty-'+t.stars+'">'+a+'</div><span class="difficulty-label">'+e.t("difficulty."+t.label)+'</span><span class="difficulty-accuracy">'+t.accuracy+"% "+e.t("difficulty.accuracy")+"</span>",n.classList.remove("hidden")}(n.song_difficulty),v){var y=document.getElementById("song-rich-info"),b=y&&""!==y.innerHTML.trim(),h=p&&""!==p.trim();v.classList.toggle("hidden",!h&&!b)}for(var E=null,I=0;I<i.length;I++)if(i[I].name===tt){E=i[I];break}!function(t){var n=document.getElementById("reveal-emotion"),a=document.getElementById("personal-result");if(!n)return;var i=n.classList.contains("reveal-emotion-inline")||document.querySelector(".reveal-container--compact");n.className=i?"reveal-emotion-inline":"reveal-emotion",n.innerHTML="",n.classList.add("hidden"),a&&a.classList.remove("is-delayed");kt();var s=e.t("reveal.emotions");function o(e){return e[Math.floor(Math.random()*e.length)]}function r(t){return 1===t?e.t("reveal.offByYear"):e.t("reveal.offByYears",{years:t})}var l="missed",d=o(s.missed),c=o(s.missedSub);if(t&&!t.missed_round){var u=t.years_off||0;0===u?(l="exact",d=o(s.exact),c=o(s.exactSub)):u<=2?(l="close",d=o(s.close),c=o(s.closeSub)+" "+r(u)):u<=5?(l="close",d=o(s.close),c=r(u)):(l="wrong",d=o(s.wrong),c=o(s.wrongSub)+" "+r(u))}else t&&t.missed_round&&(l="missed",d=o(s.missed),c=o(s.missedSub));var m='<span class="reveal-emotion-text">'+d+"</span>";c&&(m+='<div class="reveal-emotion-subtitle">'+c+"</div>");n.innerHTML=m,n.classList.add("reveal-emotion--"+l),n.classList.remove("hidden"),"exact"===l&&St();a&&"missed"!==l&&a.classList.add("is-delayed")}(E,a.year),function(n,a){var i=document.getElementById("result-content");if(!i)return;if(!n)return void(i.innerHTML='<div class="result-missed">Player not found</div>');if(n.missed_round){var s='<div class="result-missed-container"><div class="result-missed-icon">‚è∞</div><div class="result-missed-text">'+e.t("reveal.noSubmission")+"</div></div>",o=n.previous_streak||0;return o>=2&&(s+='<div class="streak-broken"><span class="streak-broken-icon">üíî</span><span class="streak-broken-text">Lost '+o+"-streak!</span></div>"),s+='<div class="result-score is-zero">0 pts</div>',void(i.innerHTML=s)}var r=n.years_off||0,l=0===r?e.t("reveal.exact"):1===r?e.t("reveal.yearOff",{years:1}):t("reveal.yearsOff",{years:r}),d=0===r?"is-exact":r<=3?"is-close":"is-far",c=n.speed_multiplier||1,u=n.base_score||0,m=c>1,v=n.streak_bonus||0,f=n.artist_bonus||0,g="";m&&u>0&&(g='<div class="result-row"><span class="result-label">'+e.t("reveal.baseScore")+'</span><span class="result-value">'+u+' pts</span></div><div class="result-row"><span class="result-label">'+e.t("reveal.speedBonus")+'</span><span class="result-value is-bonus">'+c.toFixed(2)+"x</span></div>");var p="";"won"===n.bet_outcome?p='<div class="result-row bet-won-row"><span class="result-label">üé≤ '+e.t("reveal.betWon").replace("! 2x points","")+'</span><span class="result-value is-bet-won">2x</span></div>':"lost"===n.bet_outcome&&(p='<div class="result-row bet-lost-row"><span class="result-label">üé≤ '+e.t("reveal.betLost")+'</span><span class="result-value is-bet-lost">-</span></div>');var y="";v>0&&(y='<div class="result-row streak-bonus-row"><span class="result-label">'+n.streak+'-streak bonus!</span><span class="result-value is-streak">+'+v+" pts</span></div>");var b="";f>0&&(b='<div class="result-row artist-bonus-row"><span class="result-label">üé§ '+(e.t("artistChallenge.artistBonus")||"Artist Bonus")+'</span><span class="result-value">+'+f+" pts</span></div>");var h=n.round_score+v+f,E=v>0||f>0,I=n.round_score>=20,k=_.players[n.name],x=(k?k.score:n.score,function(e,t){for(var n=0;n<S.length;n++){var a=S[n];if(e<a&&t>=a)return a}return null}(k?k.streak:0,n.streak||0));i.innerHTML='<div class="result-row"><span class="result-label">'+e.t("reveal.yourGuess")+'</span><span class="result-value">'+(n.guess||"n/a")+'</span></div><div class="result-row"><span class="result-label">'+e.t("reveal.correctYear")+'</span><span class="result-value">'+a+'</span></div><div class="result-row"><span class="result-label">'+e.t("reveal.accuracy")+'</span><span class="result-value '+d+'">'+l+"</span></div>"+g+p+'<div class="result-score" id="personal-result-score">+<span class="score-value">0</span> pts</div>'+y+b+(E?'<div class="result-total">'+e.t("reveal.total")+': +<span class="total-value">0</span> pts</div>':"");var C=i.querySelector(".score-value");C&&(!function(e,t,n,a){var i=500;(a=a||{}).betWon?i=800:a.isBigScore?i=700:a.betLost&&(i=400),e.classList.add("score-animating");var s=null;function o(){e.classList.remove("score-animating"),s&&e.classList.remove(s),e.classList.remove("score-flash-red")}a.betWon?s="score-glow-gold":a.betLost?(s="score-shake",e.classList.add("score-flash-red")):a.streakMilestone?s="score-burst":a.isBigScore&&(s="score-pop"),s&&!L()&&e.classList.add(s),w(e,t,n,i),s&&!L()?e.addEventListener("animationend",function t(){e.removeEventListener("animationend",t),o()}):setTimeout(o,i+50)}(C,0,n.round_score,{betWon:"won"===n.bet_outcome,betLost:"lost"===n.bet_outcome,streakMilestone:x,isBigScore:I}),"won"===n.bet_outcome&&n.round_score>0&&setTimeout(function(){var e=document.getElementById("personal-result-score");e&&B(e,n.round_score,{isBetWin:!0})},200));var T=i.querySelector(".total-value");T&&E&&(setTimeout(function(){w(T,0,h,600)},300),x&&setTimeout(function(){var e=i.querySelector(".result-total");if(e){var t={3:20,5:50,10:100}[x]||0;B(e,t,{isStreak:!0,text:"+"+t+" "+x+"-Streak!"})}},500))}(E,a.year),n.artist_challenge&&function(t,n){var a=document.getElementById("artist-reveal-section");if(a)if(t&&t.correct_artist){a.classList.remove("hidden");var i=document.getElementById("artist-reveal-name");i&&(i.textContent=t.correct_artist);var s=document.getElementById("artist-reveal-winner");if(s)if(t.winner)if(s.classList.remove("hidden"),t.winner===n){var o=t.bonus_points||5;s.textContent=(e.t("artistChallenge.youGotIt")||"You got it! +{points} points").replace("{points}",o),s.className="artist-reveal-winner is-you"}else{var r=(e.t("artistChallenge.winnerWas")||"{winner} got it first!").replace("{winner}",t.winner);s.textContent=r,s.className="artist-reveal-winner is-other"}else s.textContent=e.t("artistChallenge.noWinner")||"No one guessed the artist",s.className="artist-reveal-winner artist-reveal-no-winner",s.classList.remove("hidden")}else a.classList.add("hidden")}(n.artist_challenge,tt),n.movie_challenge&&function(t,n){var a=document.getElementById("movie-reveal-section");if(a)if(t&&t.correct_movie){a.classList.remove("hidden");var i=document.getElementById("movie-reveal-name");i&&(i.textContent=t.correct_movie);var s=document.getElementById("movie-reveal-winners");if(s&&t.results){var o=t.results.winners||[];if(o.length>0){s.innerHTML="",s.classList.remove("hidden");var r=document.createElement("div");r.className="movie-reveal-winners-title",r.textContent=e.t("movieChallenge.winnersTitle")||"Movie Quiz Winners",s.appendChild(r),o.forEach(function(e){var t=document.createElement("div");t.className="movie-reveal-winner-entry",e.name===n?t.classList.add("is-you"):t.classList.add("is-other"),t.textContent=e.name+" ‚Äî +"+e.bonus+" ("+e.time+"s)",s.appendChild(t)})}else{s.innerHTML="",s.classList.remove("hidden");var l=document.createElement("div");l.className="movie-reveal-no-winner",l.textContent=e.t("movieChallenge.noWinner")||"No one guessed the movie",s.appendChild(l)}}}else a.classList.add("hidden")}(n.movie_challenge,tt),n.game_performance&&n.game_performance.is_new_record&&St("record"),function(n){var a=document.getElementById("reveal-results-cards");if(!a)return;if(!n||0===n.length)return void(a.innerHTML="");var i=n.slice().sort(function(e,t){return(t.round_score||0)-(e.round_score||0)}),s='<div class="results-cards-scroll">';i.forEach(function(n){var a=n.name===tt,i=!0===n.missed_round,o=n.years_off||0,r=n.round_score||0,l=i?"is-score-zero":r>=10?"is-score-high":r>=1?"is-score-medium":"is-score-zero",d=i?"‚Äî":n.guess||"n/a",c=i?e.t("reveal.noGuessShort"):0===o?e.t("reveal.exact"):t("reveal.shortOff",{years:o}),u=n.bet?'<span class="card-bet">üé≤</span>':"",m="";n.artist_bonus&&n.artist_bonus>0&&(m='<span class="player-card-artist-badge">üé§ +'+n.artist_bonus+"</span>");var v="";if(n.stole_from)v='<div class="steal-badge"><span class="steal-badge-icon">ü•∑</span>'+t("steal.stolenFrom",{name:G(n.stole_from)})+"</div>";else if(n.was_stolen_by&&n.was_stolen_by.length>0){var f=n.was_stolen_by.map(G).join(", ");v='<div class="steal-badge steal-badge-victim"><span class="steal-badge-icon">üéØ</span>'+t("steal.stolenBy",{name:f})+"</div>"}s+='<div class="result-card '+l+(a?" is-current":"")+'"><div class="card-name">'+G(n.name)+u+'</div><div class="card-guess">'+d+'</div><div class="card-accuracy">'+c+"</div>"+v+'<div class="card-score">+'+r+m+"</div></div>"}),s+="</div>",a.innerHTML=s}(i),n.round_analytics&&function(t,n){var a=document.getElementById("round-analytics"),i=document.getElementById("round-analytics-content");if(!a||!i||!t)return void(a&&a.classList.add("hidden"));if(0===t.total_submitted)return i.innerHTML='<div class="analytics-empty">'+e.t("analytics.noSubmissions")+"</div>",void a.classList.remove("hidden");var s="";if(null!==t.average_guess&&n){var o=Math.round(t.average_guess-n);s=0===o?e.t("analytics.onTarget"):o>0?e.t("analytics.yearsLate",{years:o}):e.t("analytics.yearsEarly",{years:Math.abs(o)})}var r=function(t,n){var a=7;if(!t||0===t.length)return'<div class="histogram-empty">'+e.t("analytics.noGuesses")+"</div>";for(var i=t.map(function(e){return e.guess}),s=Math.min.apply(null,i),o=Math.max.apply(null,i)-s,r=Math.max(1,Math.ceil(o/a)),l=r*a-o-1,d=s-Math.floor(l/2),c=[],u=0;u<a;u++){var m=d+u*r,v=m+r-1;c.push({start:m,end:v,count:0,containsCorrect:n>=m&&n<=v})}for(var f=0;f<i.length;f++)for(var g=i[f],p=0;p<c.length;p++)if(g>=c[p].start&&g<=c[p].end){c[p].count++;break}for(var y=1,b=0;b<c.length;b++)c[b].count>y&&(y=c[b].count);for(var h="",E=0;E<c.length;E++){var L=c[E],I=L.count/y*100;h+='<div class="histogram-bar-wrapper" style="animation-delay: '+.05*E+'s"><div class="'+("histogram-bar"+(L.containsCorrect?" is-correct":""))+'" style="height: '+(L.count>0?Math.max(I,10):0)+'%">'+(L.count>0?'<span class="bar-count">'+L.count+"</span>":"")+'</div><span class="histogram-label">'+(1===r?String(L.start):L.start+"-"+String(L.end).slice(-2))+"</span></div>"}return'<div class="histogram-bars">'+h+"</div>"}(t.all_guesses,n),l="";t.exact_match_players&&t.exact_match_players.length>0&&(l+='<div class="achievement-item"><span class="achievement-emoji">&#127919;</span><span class="achievement-label">'+e.t("analytics.exactMatches")+':</span><span class="achievement-names">'+t.exact_match_players.join(", ")+"</span></div>");if(t.speed_champion&&t.speed_champion.names){var d=t.speed_champion.names.join(", ");l+='<div class="achievement-item"><span class="achievement-emoji">&#9889;</span><span class="achievement-label">'+e.t("analytics.speedChampion")+':</span><span class="achievement-names">'+d+'</span><span class="achievement-value">('+t.speed_champion.time+"s)</span></div>"}if(t.furthest_players&&t.furthest_players.length>0&&t.all_guesses&&t.all_guesses.length>0){var c=t.all_guesses[t.all_guesses.length-1].years_off;c>0&&(l+='<div class="achievement-item"><span class="achievement-emoji">&#128517;</span><span class="achievement-label">'+e.t("analytics.furthestGuess")+':</span><span class="achievement-names">'+t.furthest_players.join(", ")+'</span><span class="achievement-value">('+c+" years)</span></div>")}var u=null!==t.average_guess?Math.round(t.average_guess):"?";i.innerHTML='<div class="analytics-stats-row"><div class="stat-primary"><span class="stat-label">'+e.t("analytics.averageGuess")+'</span><span class="stat-value">'+u+'</span></div><div class="stat-secondary"><span class="stat-value">'+t.accuracy_percentage+'%</span><span class="stat-label">'+e.t("analytics.accuracy",{percent:""}).replace("%","")+'</span></div></div><div class="stat-comparison-line">'+s+'</div><div class="analytics-histogram"><h4 class="histogram-title">'+e.t("analytics.histogram")+"</h4>"+r+"</div>"+(l?'<div class="analytics-achievements">'+l+"</div>":""),a.classList.remove("hidden")}(n.round_analytics,a.year),n.leaderboard&&ee(n,"reveal-leaderboard-list",!0);var k=document.getElementById("reveal-admin-controls"),x=document.getElementById("next-round-btn");k&&E&&E.is_admin?(k.classList.remove("hidden"),x&&(n.last_round?(x.textContent=e.t("leaderboard.finalResults"),x.classList.add("is-final")):(x.textContent=e.t("admin.nextRound"),x.classList.remove("is-final")),x.disabled=!1)):k&&k.classList.add("hidden")}function xe(e){var t=e.toLowerCase();return-1!==t.indexOf("diamond")?"song-badge--diamond":-1!==t.indexOf("platinum")?"song-badge--platinum":-1!==t.indexOf("gold")?"song-badge--gold":"song-badge--platinum"}function Ce(e){var t=e.toLowerCase();return-1!==t.indexOf("diamond")?"üíé":-1!==t.indexOf("platinum")?"üíø":-1!==t.indexOf("gold")?"ü•á":"üíø"}function Te(e){var t=e.toLowerCase();return-1!==t.indexOf("grammy")?"song-badge--grammy":-1!==t.indexOf("eurovision")?"song-badge--eurovision":-1!==t.indexOf("oscar")||-1!==t.indexOf("academy award")?"song-badge--oscar":-1!==t.indexOf("hall of fame")?"song-badge--halloffame":"song-badge--award"}function Ne(e){var t=e.toLowerCase();return-1!==t.indexOf("eurovision")?"üé§":-1!==t.indexOf("grammy")?"üèÜ":-1!==t.indexOf("hall of fame")?"‚≠ê":"üèÜ"}function Me(t){var n=t.leaderboard||[];n.forEach(function(e){e.is_current=e.name===tt}),[1,2,3].forEach(function(e){var t=n.find(function(t){return t.rank===e}),a=document.getElementById("podium-"+e+"-name"),i=document.getElementById("podium-"+e+"-score");a&&(a.textContent=t?G(t.name):"---"),i&&(i.textContent=t?t.score:"0")});var a=n.find(function(e){return e.is_current}),i=document.getElementById("your-final-rank"),s=document.getElementById("your-final-score"),o=document.getElementById("stat-best-streak"),r=document.getElementById("stat-rounds"),l=document.getElementById("stat-bets");a&&(i&&(i.textContent="#"+a.rank),s&&(s.textContent=a.score+" "+e.t("leaderboard.points")),o&&(o.textContent=a.best_streak||0),r&&(r.textContent=a.rounds_played||0),l&&(l.textContent=a.bets_won||0));var d=document.getElementById("final-leaderboard-list");d&&(d.innerHTML=n.map(function(e){var t=e.is_current?"is-current":"",n=!1===e.connected?"final-entry--disconnected":"",a=!1===e.connected?'<span class="away-badge">(away)</span>':"";return'<div class="final-entry '+t+" "+n+'"><span class="final-rank">#'+e.rank+'</span><span class="final-name">'+G(e.name)+a+'</span><span class="final-score">'+e.score+"</span></div>"}).join("")),function(t){var n=document.getElementById("superlatives-container");if(n)if(t&&0!==t.length){var a="";t.forEach(function(t,n){var i="";switch(t.value_label){case"avg_time":i=t.value+"s "+e.t("superlatives.avgTime");break;case"streak":i=t.value+" "+e.t("superlatives.streak");break;case"bets":i=t.value+" "+e.t("superlatives.bets");break;case"points":i=t.value+" "+e.t("superlatives.points");break;case"close_guesses":i=t.value+" "+e.t("superlatives.closeGuesses");break;default:i=t.value}a+='<div class="superlative-card superlative-card--'+t.id+'" style="animation-delay: '+.2*n+'s"><div class="superlative-emoji">'+t.emoji+'</div><div class="superlative-title">'+e.t("superlatives."+t.title)+'</div><div class="superlative-player">'+G(t.player_name)+'</div><div class="superlative-value">'+i+"</div></div>"}),n.innerHTML=a,n.classList.remove("hidden")}else n.classList.add("hidden")}(t.superlatives);var c=document.getElementById("end-admin-controls"),u=document.getElementById("end-player-message");if(a&&a.is_admin){c&&c.classList.remove("hidden"),u&&u.classList.add("hidden");var m=document.getElementById("new-game-btn");m&&(m.onclick=Ae)}else c&&c.classList.add("hidden"),u&&u.classList.remove("hidden");if(a){var v=t.total_rounds||10;(a.best_streak||0)===v&&v>0?St("perfect"):1===a.rank&&St("winner")}}async function Ae(){if(await p(e.t("admin.newGameTitle")||"New Game?",e.t("admin.newGameConfirm")||"Start a new game?",e.t("admin.newGame")||"New Game",e.t("common.cancel"))){var t=document.getElementById("new-game-btn");t&&(t.disabled=!0,t.textContent="Redirecting...");try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(e){}window.location.href="/beatify/admin"}}var Oe=!1;function Re(){if(!Oe&&et&&et.readyState===WebSocket.OPEN){Oe=!0;var e=document.getElementById("next-round-btn"),t=document.getElementById("next-round-admin-btn");if(e&&(e.disabled=!0,e.textContent="Loading..."),t){t.disabled=!0;var n=t.querySelector(".control-label");n&&(n.textContent="Wait...")}et.send(JSON.stringify({type:"admin",action:"next_round"})),setTimeout(function(){Oe=!1,e&&(e.disabled=!1),t&&(t.disabled=!1)},2e3)}}let He=!1;let De=!1,qe=.5;function We(){return!He&&(He=!0,setTimeout(function(){He=!1},500),!0)}function Ge(){if(Xe){var e=document.getElementById("admin-control-bar");e&&(e.classList.remove("hidden"),document.body.classList.add("has-control-bar"))}}function Fe(){var e=document.getElementById("admin-control-bar");e&&(e.classList.add("hidden"),document.body.classList.remove("has-control-bar"))}function je(){var e=document.getElementById("reaction-bar");e&&e.classList.add("hidden")}var Pe;function ze(e){var t=document.getElementById("stop-song-btn"),n=document.getElementById("next-round-admin-btn");if("PLAYING"===e)Ze(),t&&!De&&(t.classList.remove("is-disabled"),t.disabled=!1),n&&(n.classList.remove("is-disabled"),n.disabled=!1,(a=n.querySelector(".control-label"))&&(a.textContent="Skip"));else if("REVEAL"===e){if(t&&!De&&(t.classList.remove("is-disabled"),t.disabled=!1),n)n.classList.remove("is-disabled"),n.disabled=!1,(a=n.querySelector(".control-label"))&&(a.textContent="Next")}else{var a;if(n)n.classList.add("is-disabled"),n.disabled=!0,(a=n.querySelector(".control-label"))&&(a.textContent="Next")}}function Ue(){if(!De&&We())if(et&&et.readyState===WebSocket.OPEN){var e=document.getElementById("stop-song-btn");if(e){e.classList.add("is-disabled"),e.disabled=!0;var t=e.querySelector(".control-label");t&&(t.textContent="Stopping...")}et.send(JSON.stringify({type:"admin",action:"stop_song"}))}else console.warn("[Beatify] Cannot stop song: WebSocket not connected")}function Ve(){qe>=1?Ye("max"):We()&&et&&et.readyState===WebSocket.OPEN&&et.send(JSON.stringify({type:"admin",action:"set_volume",direction:"up"}))}function Je(){qe<=0?Ye("min"):We()&&et&&et.readyState===WebSocket.OPEN&&et.send(JSON.stringify({type:"admin",action:"set_volume",direction:"down"}))}function Ye(e){var t=document.getElementById("volume-indicator");t&&(t.textContent="max"===e?"üîä Max":"üîá Min",t.classList.remove("hidden"),t.classList.add("is-visible"),setTimeout(function(){t.classList.remove("is-visible"),setTimeout(function(){t.classList.add("hidden")},300)},1e3))}async function Qe(){if(await p(e.t("admin.endGameConfirm")||"End Game?",e.t("admin.endGameWarning")||"All players will be disconnected.",e.t("admin.endGame")||"End Game",e.t("common.cancel"))&&We())if(et&&et.readyState===WebSocket.OPEN){var t=document.getElementById("end-game-btn");if(t){t.disabled=!0;var n=t.querySelector(".control-label");n&&(n.textContent="Ending...")}et.send(JSON.stringify({type:"admin",action:"end_game"}))}else alert(e.t("errors.CONNECTION_LOST"))}function $e(){Re()}function Ze(){De=!1;var e=document.getElementById("stop-song-btn");if(e){e.classList.remove("is-stopped"),e.classList.remove("is-disabled"),e.disabled=!1;var t=e.querySelector(".control-icon"),n=e.querySelector(".control-label");t&&(t.textContent="‚èπÔ∏è"),n&&(n.textContent="Stop")}}function Ke(e){qe=e,function(e){var t=document.getElementById("volume-indicator");if(!t)return;var n=Math.round(100*e);t.textContent="üîä "+n+"%",t.classList.remove("hidden"),t.classList.add("is-visible"),setTimeout(function(){t.classList.remove("is-visible"),setTimeout(function(){t.classList.add("hidden")},300)},1500)}(e),function(e){var t=document.getElementById("volume-up-btn"),n=document.getElementById("volume-down-btn");t&&t.classList.toggle("is-at-limit",e>=1);n&&n.classList.toggle("is-at-limit",e<=0)}(e)}(Pe=document.getElementById("reaction-bar"))&&Pe.querySelectorAll(".reaction-btn").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-emoji");t&&function(e){ct||(ct=!0,et&&et.readyState===WebSocket.OPEN&&et.send(JSON.stringify({type:"reaction",emoji:e})))}(t)})});let Xe=!1;let et=null,tt=null,nt=0;const at=10,it=3e4,st="beatify_player_name",ot="beatify_game_id",rt="beatify_language";let lt=!1,dt=!1,ct=!1;function ut(){return Math.min(1e3*Math.pow(2,nt),it)}function mt(e){try{localStorage.setItem(st,e),localStorage.setItem(ot,n),console.log("[Beatify] Stored player name:",e,"for game:",n)}catch(e){console.error("[Beatify] Failed to store player name:",e)}}function vt(){try{localStorage.removeItem(st),localStorage.removeItem(ot)}catch(e){}}function ft(){var e=document.getElementById("reconnecting-overlay");e&&e.classList.remove("hidden")}function gt(){var e=document.getElementById("reconnecting-overlay");e&&e.classList.add("hidden")}function pt(e){var t=document.getElementById("reconnect-status");t&&(t.textContent="Reconnecting... (Attempt "+e+"/"+at+")")}function yt(){g("connection-lost-view")}function bt(e){tt=e,mt(e);const t=("https:"===window.location.protocol?"wss:":"ws:")+"//"+window.location.host+"/beatify/ws";et=new WebSocket(t),et.onopen=function(){nt=0,lt=!1,gt();var t={type:"join",name:e};Xe&&(t.is_admin=!0),et.send(JSON.stringify(t))},et.onmessage=function(e){try{ht(JSON.parse(e.data))}catch(e){console.error("Failed to parse WebSocket message:",e)}},et.onclose=function(){if(dt)dt=!1;else if(tt&&nt<at){lt=!0,nt++,ft(),pt(nt);const e=ut();console.log("WebSocket closed. Reconnecting in "+e+"ms... (attempt "+nt+")"),setTimeout(function(){bt(tt)},e)}else nt>=at&&(lt=!1,gt(),yt())},et.onerror=function(e){console.error("WebSocket error:",e)}}function ht(t){const n=document.getElementById("join-btn"),a=document.getElementById("name-input");if("state"===t.type){var i=t.players||[],s=i.find(function(e){return e.name===tt});if(s&&(Xe=!0===s.is_admin),t.language&&(!function(e){try{localStorage.setItem(rt,e)}catch(e){}}(t.language),"undefined"!=typeof BeatifyI18n&&t.language!==BeatifyI18n.getLanguage()&&BeatifyI18n.setLanguage(t.language).then(function(){BeatifyI18n.initPageTranslations(),F(i),t.difficulty&&j(t.difficulty),"REVEAL"===t.phase&&ke(t)})),"LOBBY"===t.phase)K(),Fe(),je(),ae=0,wt("warmup"),g("lobby-view"),F(i),t.difficulty&&j(t.difficulty),t.join_url&&function(e){if(e){P=e;var t=document.getElementById("player-qr-code");t&&(t.innerHTML="","undefined"!=typeof QRCode?new QRCode(t,{text:e,width:128,height:128,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):t.innerHTML='<p class="status-error">QR code library not loaded</p>',t.onclick=z,t.onkeydown=function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),z())})}}(t.join_url),function(e){const t=document.getElementById("admin-controls"),n=document.getElementById("lobby-status");if(!t)return;e&&Array.isArray(e)||(e=[]);const a=e.find(function(e){return e.name===tt});!0===a?.is_admin?(t.classList.remove("hidden"),n&&n.classList.add("hidden")):(t.classList.add("hidden"),n&&n.classList.remove("hidden"))}(i);else if("PLAYING"===t.phase){var o=t.round||1;o!==ae&&(ae=o,ye()),wt("party"),g("game-view"),J(),X(t),t.difficulty&&j(t.difficulty),t.deadline&&function(e){K();var t=document.getElementById("timer");function n(){var n=Date.now(),a=Math.max(0,Math.ceil((e-n)/1e3));t.textContent=a,a<=5?(t.classList.remove("timer--warning"),t.classList.add("timer--critical")):a<=10?(t.classList.remove("timer--critical"),t.classList.add("timer--warning")):t.classList.remove("timer--warning","timer--critical"),10===a?t.setAttribute("aria-label","10 seconds remaining"):5===a?t.setAttribute("aria-label","5 seconds!"):0===a?t.setAttribute("aria-label","Time is up!"):t.setAttribute("aria-label","Time remaining: "+a+" seconds"),a<=0&&K()}t&&(t.classList.remove("timer--warning","timer--critical"),n(),Z=setInterval(n,1e3))}(t.deadline),function(){var e=document.getElementById("year-slider"),t=document.getElementById("selected-year");if(e&&t){e.addEventListener("input",function(){t.textContent=this.value});var n=document.getElementById("bet-toggle");n&&n.addEventListener("click",function(){te||(ne=!ne,n.classList.toggle("is-active",ne))});var a=document.getElementById("submit-btn");a&&a.addEventListener("click",fe);var i=document.getElementById("steal-btn");i&&i.addEventListener("click",we);var s=document.getElementById("steal-modal-close");s&&s.addEventListener("click",_e);var o=document.getElementById("steal-modal");if(o){var r=o.querySelector(".steal-modal-backdrop");r&&r.addEventListener("click",_e)}}}(),c=document.getElementById("leaderboard-toggle"),u=document.getElementById("game-leaderboard"),c&&u&&!c.hasAttribute("data-initialized")&&(c.setAttribute("data-initialized","true"),c.addEventListener("click",function(){var e=u.classList.toggle("collapsed");c.setAttribute("aria-expanded",!e)})),Ge(),ze("PLAYING"),je()}else"REVEAL"===t.phase?(K(),t.early_reveal&&(d=document.getElementById("volume-indicator"))&&(d.textContent=e.t("earlyReveal.message")||"All guesses in!",d.classList.remove("hidden"),d.classList.add("is-visible"),setTimeout(function(){d.classList.remove("is-visible"),setTimeout(function(){d.classList.add("hidden")},300)},1500)),wt("party"),g("reveal-view"),ke(t),function(){var e=document.getElementById("reveal-leaderboard-toggle"),t=document.getElementById("reveal-leaderboard");e&&t&&!e.hasAttribute("data-initialized")&&(e.setAttribute("data-initialized","true"),e.addEventListener("click",function(){var n=t.classList.toggle("collapsed");e.setAttribute("aria-expanded",!n)}))}(),function(){var e=document.getElementById("round-analytics-toggle"),t=document.getElementById("round-analytics");e&&t&&!e.hasAttribute("data-initialized")&&(e.setAttribute("data-initialized","true"),e.addEventListener("click",function(){var n=t.classList.toggle("collapsed");e.setAttribute("aria-expanded",!n)}))}(),Ge(),ze("REVEAL"),ct=!1,function(){var e=document.getElementById("reaction-bar");e&&e.classList.remove("hidden")}()):"PAUSED"===t.phase?(K(),Fe(),je(),wt("warmup"),g("paused-view"),function(e){var t=document.getElementById("pause-message");t&&("admin_disconnected"===e.pause_reason?t.textContent="Waiting for host to reconnect...":"media_player_error"===e.pause_reason?t.textContent="Speaker unavailable. Please check your media player and try again.":t.textContent="Game paused. Please wait...")}(t)):"END"===t.phase&&(K(),Fe(),je(),ae=0,wt("warmup"),g("end-view"),Me(t),vt())}else if("join_ack"===t.type){t.session_id&&(r=t.session_id,l="https:"===location.protocol?"; Secure":"",document.cookie=b+"="+r+"; path=/beatify; SameSite=Strict; max-age=86400"+l);try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(e){}}else if("reconnect_ack"===t.type)t.success&&t.name?(tt=t.name,mt(t.name),function(e){var t=document.getElementById("volume-indicator");t&&(t.textContent="Welcome back, "+e+"!",t.classList.remove("hidden"),t.classList.add("is-visible"),setTimeout(function(){t.classList.remove("is-visible"),setTimeout(function(){t.classList.add("hidden")},300)},2e3))}(t.name)):(E(),vt(),tt=null,g("join-view"));else if("submit_ack"===t.type)ge();else if("metadata_update"===t.type)!function(e){if(e){var t=document.getElementById("album-cover"),n=document.getElementById("album-loading");if(t&&e.album_art){var a=e.album_art;if(t.src===a)return;t.style.transition="opacity 0.3s ease-in-out",t.style.opacity="0.5";var i=new Image;i.onload=function(){t.src=a,t.style.opacity="1",n&&n.classList.add("hidden")},i.onerror=function(){t.src="/beatify/static/img/no-artwork.svg",t.style.opacity="1",n&&n.classList.add("hidden")},i.src=a}console.log("[Metadata] Updated:",e.artist,"-",e.title)}}(t.song);else if("error"===t.type){if("ROUND_EXPIRED"===t.code||"ALREADY_SUBMITTED"===t.code)return void function(e){var t=document.getElementById("submit-btn");t&&(t.disabled=!1,t.classList.remove("is-loading")),"ROUND_EXPIRED"===e.code?(pe("Time's up!"),te=!0,t&&(t.disabled=!0)):"ALREADY_SUBMITTED"===e.code?ge():pe(e.message||"Submission failed")}(t);if("GAME_ENDED"===t.code)return void g("end-view");if("NOT_ADMIN"===t.code)return Xe=!1,Fe(),void console.warn("Admin action rejected: not admin");if("SESSION_TAKEOVER"===t.code)return lt=!1,gt(),tt=null,yt(),void console.warn("Session taken over by another tab");if("SESSION_NOT_FOUND"===t.code)return E(),dt=!0,et&&et.close(),void g("join-view");if("ADMIN_CANNOT_LEAVE"===t.code)return dt=!1,void alert(t.message||"Host cannot leave. End the game instead.");if("INVALID_ACTION"===t.code&&"No song playing"===t.message)return Ze(),void console.warn("[Beatify] Stop song failed: No song playing");g("join-view"),function(e){const t=document.getElementById("name-validation-msg");t&&(t.textContent=e,t.classList.remove("hidden"))}(t.message),n&&(n.disabled=!1,n.textContent=e.t("join.joinButton")),a&&a.focus(),tt=null,vt()}else"song_stopped"===t.type?function(){De=!0;var e=document.getElementById("stop-song-btn");if(e){e.classList.add("is-stopped"),e.classList.add("is-disabled"),e.disabled=!0;var t=e.querySelector(".control-icon"),n=e.querySelector(".control-label");t&&(t.textContent="‚úì"),n&&(n.textContent="Stopped")}}():"volume_changed"===t.type?Ke(t.level):"game_ended"===t.type?function(){var e=Xe;vt(),E();try{sessionStorage.removeItem("beatify_admin_name"),sessionStorage.removeItem("beatify_is_admin")}catch(e){}T.observer&&(T.observer.disconnect(),T.observer=null),T.isLazyEnabled=!1,void(T.fullData=[]),t=R.container,t&&R.scrollHandler&&t.removeEventListener("scroll",R.scrollHandler),R.resizeHandler&&window.removeEventListener("resize",R.resizeHandler),R.container=null,R.items=[],R.isVirtual=!1,R.topSpacer=null,R.bottomSpacer=null,void(R.contentWrapper=null),x.clear(),kt(),tt=null,Xe=!1,et&&et.readyState===WebSocket.OPEN&&et.close();var t;if(et=null,e)return void setTimeout(function(){window.location.href="/beatify/admin"},5e3);if(!m||!m.classList.contains("hidden"))return;var n=document.getElementById("end-player-message");n&&(n.innerHTML='<p>Thanks for playing!</p><p class="rejoin-hint">Scan the QR code again to join the next game.</p>',n.classList.remove("hidden"));g("end-view")}():"rematch_started"===t.type?(console.log("[Player] Rematch started - transitioning to lobby"),x.clear(),kt()):"left"===t.type?(vt(),E(),tt=null,Xe=!1,g("join-view")):"steal_targets"===t.type?function(e){Be(e.targets||[])}(t):"steal_ack"===t.type?Se(t):"artist_guess_ack"===t.type?function(t){var n=oe?document.querySelector('.artist-option-btn[data-artist="'+CSS.escape(oe)+'"]'):null;if(t.correct&&t.first){if(re=oe,n){n.classList.remove("is-loading"),n.classList.add("is-correct");var a=document.createElement("span");a.className="artist-points-badge",a.textContent="+"+(t.bonus_points||5),n.appendChild(a)}be(),he((e.t("artistChallenge.youGotIt")||"You got it! +{points} points").replace("{points}",t.bonus_points||5),!0),se=!0}else t.correct&&!t.first?(re=oe,n&&(n.classList.remove("is-loading"),n.classList.add("is-correct")),be(),he((e.t("artistChallenge.someoneBeatYou")||"{winner} got it first!").replace("{winner}",t.winner||"Someone"),!1),se=!0):(n&&(n.classList.remove("is-loading"),n.classList.add("is-wrong","is-selected")),be(),he(e.t("artistChallenge.wrongGuess")||"Wrong guess!",!1),se=!0);oe=null}(t):"movie_guess_ack"===t.type?function(t){var n=ue?document.querySelector('.movie-option-btn[data-movie="'+CSS.escape(ue)+'"]'):null;if(t.already_guessed)n&&n.classList.remove("is-loading"),Le(e.t("movieChallenge.alreadyGuessed")||"Already guessed!",!1),ce=!0,Ee();else if(t.correct){if(n&&(n.classList.remove("is-loading"),n.classList.add("is-correct"),t.bonus>0)){var a=document.createElement("span");a.className="movie-rank-badge",a.textContent="+"+t.bonus,n.appendChild(a)}Ee(),Le((e.t("movieChallenge.youGotIt")||"Correct! #{rank} ‚Äî +{bonus} points").replace("{rank}",t.rank||1).replace("{bonus}",t.bonus||0),!0),ce=!0}else n&&(n.classList.remove("is-loading"),n.classList.add("is-wrong","is-selected")),Ee(),Le(e.t("movieChallenge.wrongGuess")||"Not quite...",!1),ce=!0;ue=null}(t):"player_reaction"===t.type&&function(e,t){var n=document.getElementById("reaction-container");if(n){var a=document.createElement("div");a.className="reaction-bubble",a.textContent=e+" "+t,a.style.left=20+60*Math.random()+"%",n.appendChild(a),setTimeout(function(){a.remove()},3e3)}}(t.player_name,t.emoji);var r,l,d,c,u}function Et(e){const t=(e||"").trim();return t?t.length>20?{valid:!1,error:"Name too long (max 20 characters)"}:{valid:!0,name:t}:{valid:!1,error:"Please enter a name"}}function Lt(){const e=document.getElementById("name-input"),t=document.getElementById("join-btn"),n=document.getElementById("name-validation-msg");if(!e||!t)return;const a=Et(e.value);a.valid&&(t.disabled=!0,t.textContent="Joining...",n&&n.classList.add("hidden"),bt(a.name))}const It=g;function wt(e){document.body.classList.remove("energy-calm","energy-warmup","energy-party"),document.body.classList.add("energy-"+e)}g=function(e){It(e),"join-view"!==e&&"loading-view"!==e&&"not-found-view"!==e&&"ended-view"!==e&&"in-progress-view"!==e&&"connection-lost-view"!==e||wt("calm"),"join-view"===e&&setTimeout(function(){var e=document.getElementById("name-input");e&&e.focus()},100)};var Bt=null,_t=null;function St(e){if(k.prefersReducedMotion())xt();else if("undefined"!=typeof confetti){kt();var t=k.getQualitySettings().confettiParticles;if(0!==t){var n=k.getDeviceTier(),a="low"===n?.5:"medium"===n?.75:1;switch(e=e||"exact"){case"exact":var i=Math.round(2e3*a),s=Date.now()+i;!function e(){confetti({particleCount:t,spread:70,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]}),Date.now()<s&&(Bt=requestAnimationFrame(e))}();break;case"record":var o=Math.round(3e3*a),r=Date.now()+o;!function e(){confetti({particleCount:Math.round(.67*t),spread:180,origin:{y:.3,x:Math.random()},colors:["#ff0000","#ff7f00","#ffff00","#00ff00","#0000ff","#8b00ff"]}),Date.now()<r&&(Bt=requestAnimationFrame(e))}();break;case"winner":var l=Math.round(4e3*a),d=Date.now()+l;!function e(){confetti({particleCount:Math.round(.67*t),angle:60,spread:55,origin:{x:0},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),confetti({particleCount:Math.round(.67*t),angle:120,spread:55,origin:{x:1},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),Date.now()<d&&(Bt=requestAnimationFrame(e))}();break;case"perfect":var c=Math.round(5e3*a),u=Date.now()+c;_t=setInterval(function(){confetti({particleCount:2*t,spread:100,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]})},"low"===n?750:500),setTimeout(function(){_t&&(clearInterval(_t),_t=null)},c),function e(){confetti({particleCount:Math.round(.5*t),angle:60,spread:55,origin:{x:0},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),confetti({particleCount:Math.round(.5*t),angle:120,spread:55,origin:{x:1},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),Date.now()<u&&(Bt=requestAnimationFrame(e))}();break;default:console.warn("[Confetti] Unknown type:",e)}}else xt()}else console.warn("[Confetti] Library not loaded")}function kt(){Bt&&(cancelAnimationFrame(Bt),Bt=null),_t&&(clearInterval(_t),_t=null),"undefined"!=typeof confetti&&confetti.reset&&confetti.reset()}function xt(){var e=document.getElementById("reveal-emotion");if(e&&!e.querySelector(".celebration-icon")){var t=document.createElement("span");t.className="celebration-icon",t.textContent=" üéâ",e.appendChild(t)}}async function Ct(){var t=k.getDeviceTier();if(document.body.classList.add("device-tier-"+t),await e.waitForI18n()){var a=function(){try{return localStorage.getItem(rt)}catch(e){return null}}();await BeatifyI18n.init(a),BeatifyI18n.initPageTranslations()}else console.error("[Player] BeatifyI18n module failed to load - UI will use fallback text");var i=document.getElementById("dashboard-hint-url");i&&(i.textContent=window.location.origin+"/beatify/dashboard");var s,o,r,l,d,c,u,m,v,f=document.getElementById("player-dashboard-url");if(f&&(f.href=window.location.origin+"/beatify/dashboard"),function(){const e=document.getElementById("name-input"),t=document.getElementById("join-btn"),n=document.getElementById("name-validation-msg");e&&t&&(e.addEventListener("input",function(){const e=Et(this.value);t.disabled=!e.valid,n&&(n.textContent=!e.valid&&this.value?e.error:"",n.classList.toggle("hidden",e.valid||!this.value))}),t.addEventListener("click",Lt),e.addEventListener("keypress",function(e){"Enter"!==e.key||t.disabled||Lt()}))}(),s=document.getElementById("qr-modal"),o=s?s.querySelector(".qr-modal-backdrop"):null,r=document.getElementById("qr-modal-close"),o&&o.addEventListener("click",U),r&&r.addEventListener("click",U),document.addEventListener("keydown",function(e){"Escape"===e.key&&s&&!s.classList.contains("hidden")&&U()}),function(){var e=document.getElementById("invite-modal"),t=e?e.querySelector(".invite-modal-backdrop"):null,n=document.getElementById("invite-modal-close"),a=document.getElementById("invite-players-btn"),i=document.getElementById("invite-copy-btn");t&&t.addEventListener("click",J),n&&n.addEventListener("click",J),a&&a.addEventListener("click",V),i&&i.addEventListener("click",Y),document.addEventListener("keydown",function(t){"Escape"===t.key&&e&&!e.classList.contains("hidden")&&J()})}(),function(){const e=document.getElementById("start-game-btn");e?.addEventListener("click",function(){et&&et.readyState===WebSocket.OPEN&&(e.disabled=!0,e.textContent="Starting...",et.send(JSON.stringify({type:"admin",action:"start_game"})))})}(),function(){var e=document.getElementById("next-round-btn");e&&e.addEventListener("click",Re);var t=document.getElementById("reveal-view");t&&t.addEventListener("click",function(e){"BUTTON"===e.target.tagName||e.target.closest("button")||(x.isRunning()&&x.skipAll(),kt())})}(),l=document.getElementById("stop-song-btn"),d=document.getElementById("volume-up-btn"),c=document.getElementById("volume-down-btn"),u=document.getElementById("next-round-admin-btn"),m=document.getElementById("end-game-btn"),l&&l.addEventListener("click",Ue),d&&d.addEventListener("click",Ve),c&&c.addEventListener("click",Je),u&&u.addEventListener("click",$e),m&&m.addEventListener("click",Qe),(v=document.getElementById("retry-connection-btn"))&&v.addEventListener("click",function(){tt?(nt=0,g("loading-view"),bt(tt)):y()}),function(){var e;function t(){clearTimeout(e),e=setTimeout(function(){T.isLazyEnabled&&T.fullData.length>0&&(T.visibleRange=A(T.fullData,tt),N())},150)}window.addEventListener("resize",t),window.addEventListener("orientationchange",t)}(),function(){var e=document.getElementById("qr-share-area");if(e&&"DETAILS"===e.tagName){var t="beatify_qr_expanded",n=sessionStorage.getItem(t);e.open=null!==n?"true"===n:window.innerWidth>=768,e.addEventListener("toggle",function(){sessionStorage.setItem(t,e.open.toString())})}}(),document.querySelectorAll(".lobby-container--compact .section-header-collapsible").forEach(function(e){e.addEventListener("click",function(){var t=e.closest(".section-collapsible");if(t){var n=t.classList.contains("collapsed");t.classList.toggle("collapsed"),e.setAttribute("aria-expanded",n?"true":"false")}})}),function(){const e=sessionStorage.getItem("beatify_is_admin"),t=sessionStorage.getItem("beatify_admin_name");return"true"===e&&t&&(Xe=!0,tt=t,sessionStorage.removeItem("beatify_is_admin")),Xe}()&&tt)bt(tt);else{var p=function(){try{var e=localStorage.getItem(ot),t=localStorage.getItem(st);if(console.log("[Beatify] Checking localStorage - storedGameId:",e,"currentGameId:",n,"storedName:",t),e&&e===n)return console.log("[Beatify] Game ID match, returning stored name:",t),t;e&&e!==n&&(console.log("[Beatify] Different game ID, clearing stored data"),localStorage.removeItem(st),localStorage.removeItem(ot))}catch(e){console.error("[Beatify] localStorage error:",e)}return null}();if(p&&n)return console.log("[Beatify] Auto-reconnecting as:",p),void bt(p);if(p){var b=document.getElementById("name-input"),h=document.getElementById("join-btn");if(b&&(b.value=p,h)){var E=Et(p);h.disabled=!E.valid}}}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",Ct):Ct(),"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/beatify/static/sw.js",{scope:"/beatify/"}).then(function(e){console.log("[Beatify] SW registered:",e.scope)}).catch(function(e){console.warn("[Beatify] SW registration failed:",e)})})}();
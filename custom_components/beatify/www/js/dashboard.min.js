(()=>{var M=(k,I,h)=>new Promise((_,w)=>{var B=l=>{try{f(h.next(l))}catch(y){w(y)}},C=l=>{try{f(h.throw(l))}catch(y){w(y)}},f=l=>l.done?_(l.value):Promise.resolve(l.value).then(B,C);f((h=h.apply(k,I)).next())});(function(){"use strict";var k=document.getElementById("dashboard-loading"),I=document.getElementById("dashboard-no-game"),h=document.getElementById("dashboard-lobby"),_=document.getElementById("dashboard-playing"),w=document.getElementById("dashboard-reveal"),B=document.getElementById("dashboard-end"),C=document.getElementById("dashboard-paused"),f=null,l=0,y=20,q=3e4,S=[],E=null,T=null;function O(e,n){return M(this,null,function*(){e=e||3e3,n=n||50;for(var r=Date.now();typeof BeatifyI18n=="undefined";){if(Date.now()-r>e)return!1;yield new Promise(function(a){setTimeout(a,n)})}return!0})}function u(e,n){if(typeof BeatifyI18n!="undefined"&&BeatifyI18n.t)return BeatifyI18n.t(e,n);var r=e.split(".").pop().replace(/([A-Z])/g," $1").replace(/^./,function(a){return a.toUpperCase()}).trim();return n&&typeof n=="object"&&Object.keys(n).forEach(function(a){r=r.replace(new RegExp("\\{"+a+"\\}","g"),n[a])}),r}function U(e,n){if(!e)return null;var r=typeof BeatifyI18n!="undefined"?BeatifyI18n.getLanguage():"en";if(r&&r!=="en"){var a=n+"_"+r;if(e[a])return e[a]}return e[n]||null}function v(e){var n=[k,I,h,_,w,B,C];n.forEach(function(a){a&&a.classList.add("hidden")});var r=document.getElementById(e);r&&r.classList.remove("hidden")}function m(e){var n=document.createElement("div");return n.textContent=e,n.innerHTML}function W(){return Math.min(1e3*Math.pow(2,l),q)}function A(){var e=window.location.protocol==="https:"?"wss:":"ws:",n=e+"//"+window.location.host+"/beatify/ws";f=new WebSocket(n),f.onopen=function(){console.log("[Dashboard] WebSocket connected"),l=0,f.send(JSON.stringify({type:"get_state"}))},f.onmessage=function(r){try{var a=JSON.parse(r.data);j(a)}catch(s){console.error("[Dashboard] Failed to parse message:",s)}},f.onclose=function(){if(console.log("[Dashboard] WebSocket closed"),l<y){l++;var r=W();console.log("[Dashboard] Reconnecting in "+r+"ms (attempt "+l+")"),setTimeout(A,r)}else v("dashboard-no-game")},f.onerror=function(r){console.error("[Dashboard] WebSocket error:",r)}}function j(e){e.type==="state"?(e.game_performance&&console.log("[Dashboard] game_performance:",e.game_performance),R(e)):e.type==="error"?console.log("[Dashboard] Server error:",e.message):e.type==="player_reaction"&&de(e.player_name,e.emoji)}function R(e){var n=e.phase;if(typeof BeatifyI18n!="undefined"&&e.language&&e.language!==BeatifyI18n.getLanguage()){BeatifyI18n.setLanguage(e.language).then(function(){BeatifyI18n.initPageTranslations(),R(e)});return}if(!n||n==="END"&&!e.game_id){v("dashboard-no-game"),g();return}switch(n){case"LOBBY":g(),v("dashboard-lobby"),Q(e);break;case"PLAYING":v("dashboard-playing"),X(e);break;case"REVEAL":g(),v("dashboard-reveal"),K(e);break;case"END":g(),v("dashboard-end"),se(e);break;case"PAUSED":g(),v("dashboard-paused");break;default:console.log("[Dashboard] Unknown phase:",n)}}function Q(e){var n=e.players||[];e.join_url&&Y(e.join_url),G(e);var r=document.getElementById("dashboard-player-count");if(r){var a=n.length;r.textContent=a+" player"+(a!==1?"s":"")+" joined"}J(n)}function G(e){var n=document.getElementById("dashboard-game-settings");if(n){var r=e.total_rounds||10,a=e.difficulty||"normal",s=u("admin.difficulty"+a.charAt(0).toUpperCase()+a.slice(1),a);n.textContent=r+" "+u("dashboard.rounds","rounds")+" \u2022 "+s}}function Y(e){var n=document.getElementById("dashboard-qr-code");n&&e!==T&&(T=e,n.innerHTML="",typeof QRCode!="undefined"?new QRCode(n,{text:e,width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}):n.innerHTML="<p>QR code unavailable</p>")}function J(e){var n=document.getElementById("dashboard-player-list");if(n){var r=e.slice().sort(function(t,i){return t.connected!==i.connected?t.connected?-1:1:0}),a=S.map(function(t){return t.name}),s=r.filter(function(t){return a.indexOf(t.name)===-1}).map(function(t){return t.name});n.innerHTML=r.map(function(t){var i=s.indexOf(t.name)!==-1,d=t.connected===!1,c=["dashboard-player-card"];i&&c.push("is-new"),d&&c.push("dashboard-player-card--disconnected");var o=d?'<span class="away-badge">(away)</span>':"";return'<div class="'+c.join(" ")+'">'+m(t.name)+o+"</div>"}).join(""),setTimeout(function(){for(var t=n.querySelectorAll(".is-new"),i=0;i<t.length;i++)t[i].classList.remove("is-new")},2e3),S=e.slice()}}function X(e){var n=e.song||{},r=e.players||[],a=document.getElementById("dashboard-current-round"),s=document.getElementById("dashboard-total-rounds");a&&(a.textContent=e.round||1),s&&(s.textContent=e.total_rounds||10);var t=document.getElementById("dashboard-album-art");t&&(t.src=n.album_art||"/beatify/static/img/no-artwork.svg",t.onerror=function(){this.src="/beatify/static/img/no-artwork.svg"}),e.deadline&&Z(e.deadline),$(e.leaderboard||[],r,"dashboard-leaderboard",!0,!0),z(e,r)}function z(e,n){console.log("[Dashboard] renderRoundStats called, players:",n),console.log("[Dashboard] data.players:",e.players);var r=0,a=n.length;n.forEach(function(d){d.submitted&&r++}),console.log("[Dashboard] Submissions:",r,"/",a);var s=document.getElementById("dashboard-submissions");s?(s.textContent=r+"/"+a,console.log("[Dashboard] Updated submissions element")):console.warn("[Dashboard] dashboard-submissions element not found");var t=document.getElementById("dashboard-time-remaining");if(t&&e.deadline){var i=Math.max(0,Math.ceil((e.deadline-Date.now())/1e3));t.textContent=i+"s"}}function Z(e){g();var n=document.getElementById("dashboard-timer"),r=document.getElementById("dashboard-time-remaining");if(!n)return;n.classList.remove("timer--warning","timer--critical");function a(){var s=Date.now(),t=Math.max(0,Math.ceil((e-s)/1e3));n.textContent=t,r&&(r.textContent=t+"s"),t<=5?(n.classList.remove("timer--warning"),n.classList.add("timer--critical")):t<=10?(n.classList.remove("timer--critical"),n.classList.add("timer--warning")):n.classList.remove("timer--warning","timer--critical"),t<=0&&g()}a(),E=setInterval(a,1e3)}function g(){E&&(clearInterval(E),E=null)}function $(e,n,r,a,s){var t=document.getElementById(r);if(t){var i={},d={};n&&n.forEach(function(o){i[o.name]=o.submitted,d[o.name]=o.bet});var c="";e.forEach(function(o){var D=o.rank<=3?"is-top-"+o.rank:"",L="";o.rank_change>0?L="leaderboard-entry--climbing":o.rank_change<0&&(L="leaderboard-entry--falling");var le=o.connected===!1?"leaderboard-entry--disconnected":"",fe=o.connected===!1?'<span class="away-badge">(away)</span>':"",F="";o.rank_change>0?F='<span class="rank-up">\u25B2'+o.rank_change+"</span>":o.rank_change<0&&(F='<span class="rank-down">\u25BC'+Math.abs(o.rank_change)+"</span>");var V="";if(o.streak>=2){var ue=o.streak>=5?"streak-indicator--hot":"";V='<span class="streak-indicator '+ue+'">\u{1F525}'+o.streak+"</span>"}var H="";s&&d[o.name]&&(H='<span class="bet-badge">BET</span>');var P="";if(a){var ve=i[o.name]===!0;P='<div class="entry-submitted '+(ve?"is-submitted":"")+'"></div>'}c+='<div class="leaderboard-entry '+D+" "+L+" "+le+'"><span class="entry-rank">#'+o.rank+'</span><span class="entry-name">'+m(o.name)+fe+H+'</span><span class="entry-meta">'+V+F+'</span><span class="entry-score">'+o.score+"</span>"+P+"</div>"}),t.innerHTML=c}}function K(e){var n=e.song||{},r=e.players||[],a=document.getElementById("reveal-album-art");a&&(a.src=n.album_art||"/beatify/static/img/no-artwork.svg",a.onerror=function(){this.src="/beatify/static/img/no-artwork.svg"});var s=document.getElementById("reveal-artist"),t=document.getElementById("reveal-title"),i=document.getElementById("reveal-year");if(s&&(s.textContent=n.artist||"Unknown Artist"),t&&(t.textContent=n.title||"Unknown Song"),i&&(i.textContent=n.year||"????"),ee(n),te(r),re(e.leaderboard||[]),ne(e.game_performance),ae(e.song_difficulty),e.game_performance&&e.game_performance.is_new_record)x("record");else{var d=r.some(function(c){return c.years_off===0&&!c.missed_round});d&&x("exact")}}function ee(e){var n=document.getElementById("dashboard-fun-fact"),r=document.getElementById("dashboard-fun-fact-text"),a=U(e,"fun_fact");if(console.log("[Dashboard] renderFunFact called with song:",e),console.log("[Dashboard] fun_fact value:",a||"no fun fact"),!n||!r){console.warn("[Dashboard] Fun fact elements not found");return}if(!a||a.trim()===""){n.classList.add("hidden"),console.log("[Dashboard] No fun_fact, hiding container");return}r.textContent=a,n.classList.remove("hidden"),console.log("[Dashboard] Fun fact shown:",a)}function ne(e){var n=document.getElementById("reveal-motivational");if(n){if(!e||!e.message){n.classList.add("hidden");return}var r=e.message,a=n.querySelector(".motivational-icon"),s=n.querySelector(".motivational-text");n.className="motivational-message motivational-message--"+r.type;var t={first:"\u{1F31F}",record:"\u{1F3C6}",strong:"\u{1F525}",above:"\u{1F4C8}",close:"\u{1F4AA}"};a&&(a.textContent=t[r.type]||""),s&&(s.textContent=r.message||"")}}function ae(e){var n=document.getElementById("song-difficulty");if(n){if(!e){n.classList.add("hidden");return}for(var r="",a=0;a<e.stars;a++)r+='<span class="star">&#9733;</span>';n.innerHTML='<div class="difficulty-stars difficulty-'+e.stars+'">'+r+'</div><span class="difficulty-label">'+u("difficulty."+e.label)+'</span><span class="difficulty-accuracy">'+e.accuracy+"% "+u("difficulty.accuracy")+"</span>",n.classList.remove("hidden")}}function te(e){var n=document.getElementById("reveal-top-guesses-list");if(n){var r=e.filter(function(s){return!s.missed_round}).sort(function(s,t){return(t.round_score||0)-(s.round_score||0)}).slice(0,3),a="";r.forEach(function(s,t){var i=s.guess?'<span class="top-guess-year">('+s.guess+")</span>":"",d="";if(s.bet){var c="bet-badge";s.bet_outcome==="won"?c+=" bet-badge--won":s.bet_outcome==="lost"&&(c+=" bet-badge--lost"),d='<span class="'+c+'">BET</span>'}a+='<div class="top-guess-entry"><span class="top-guess-rank">#'+(t+1)+'</span><span class="top-guess-name">'+m(s.name)+i+'</span><span class="top-guess-points">+'+(s.round_score||0)+d+"</span></div>"}),n.innerHTML=a}}function re(e){var n=document.getElementById("reveal-leaderboard");if(n){var r="";e.forEach(function(a){var s=a.rank<=3?"is-top-"+a.rank:"",t="";a.rank_change>0?t="leaderboard-entry--climbing":a.rank_change<0&&(t="leaderboard-entry--falling");var i=a.connected===!1?"leaderboard-entry--disconnected":"",d=a.connected===!1?'<span class="away-badge">(away)</span>':"",c="";a.rank_change>0?c='<span class="entry-change is-positive">\u25B2'+a.rank_change+"</span>":a.rank_change<0&&(c='<span class="entry-change is-negative">\u25BC'+Math.abs(a.rank_change)+"</span>");var o="";if(a.streak>=2){var D=a.streak>=5?"streak-indicator--hot":"";o='<span class="streak-indicator '+D+'">\u{1F525}'+a.streak+"</span>"}r+='<div class="leaderboard-entry '+s+" "+t+" "+i+'"><span class="entry-rank">#'+a.rank+'</span><span class="entry-name">'+m(a.name)+d+'</span><span class="entry-meta">'+o+c+'</span><span class="entry-score">'+a.score+"</span></div>"}),n.innerHTML=r}}function se(e){var n=e.leaderboard||[];[1,2,3].forEach(function(t){var i=n.find(function(o){return o.rank===t}),d=document.getElementById("end-podium-"+t+"-name"),c=document.getElementById("end-podium-"+t+"-score");d&&(d.textContent=i?m(i.name):"---"),c&&(c.textContent=i?i.score:"0")}),oe(e.game_performance),ie(e.superlatives);var r=n.find(function(t){return t.rank===1});r&&r.score>0&&x("winner");var a=document.getElementById("end-leaderboard");if(a){var s="";n.forEach(function(t){var i=t.rank<=3?"is-top-"+t.rank:"",d=t.connected===!1?"leaderboard-entry--disconnected":"",c=t.connected===!1?'<span class="away-badge">(away)</span>':"";s+='<div class="leaderboard-entry '+i+" "+d+'"><span class="entry-rank">#'+t.rank+'</span><span class="entry-name">'+m(t.name)+c+'</span><span class="entry-score">'+t.score+"</span></div>"}),a.innerHTML=s}}function oe(e){var n=document.getElementById("end-stats-comparison");if(n){if(!e){n.classList.add("hidden");return}var r=n.querySelector(".stats-comparison-icon"),a=n.querySelector(".stats-comparison-text"),s="",t="",i="stats-comparison";e.is_first_game?(s="\u{1F31F}",t="First game recorded! Avg: "+e.current_avg.toFixed(1)+" pts/round",i+=" stats-comparison--first"):e.is_new_record?(s="\u{1F3C6}",t="NEW RECORD! "+e.current_avg.toFixed(1)+" pts/round (prev: "+e.all_time_avg.toFixed(1)+")",i+=" stats-comparison--record"):e.is_above_average?(s="\u{1F4C8}",t=e.current_avg.toFixed(1)+" pts/round (+"+e.difference.toFixed(1)+" vs all-time avg)",i+=" stats-comparison--above"):(s="\u{1F4CA}",t=e.current_avg.toFixed(1)+" pts/round ("+e.difference.toFixed(1)+" vs all-time avg)",i+=" stats-comparison--below"),n.className=i,r&&(r.textContent=s),a&&(a.textContent=t)}}function ie(e){var n=document.getElementById("superlatives-container");if(n){if(!e||e.length===0){n.classList.add("hidden");return}var r="";e.forEach(function(a,s){var t="";switch(a.value_label){case"avg_time":t=a.value+"s "+u("superlatives.avgTime");break;case"streak":t=a.value+" "+u("superlatives.streak");break;case"bets":t=a.value+" "+u("superlatives.bets");break;case"points":t=a.value+" "+u("superlatives.points");break;case"close_guesses":t=a.value+" "+u("superlatives.closeGuesses");break;default:t=a.value}r+='<div class="superlative-card superlative-card--'+a.id+'" style="animation-delay: '+s*.2+'s"><div class="superlative-emoji">'+a.emoji+'</div><div class="superlative-title">'+u("superlatives."+a.title)+'</div><div class="superlative-player">'+m(a.player_name)+'</div><div class="superlative-value">'+t+"</div></div>"}),n.innerHTML=r,n.classList.remove("hidden")}}var p=null,b=null;function x(e){if(!window.matchMedia("(prefers-reduced-motion: reduce)").matches){if(typeof confetti=="undefined"){console.warn("[Dashboard Confetti] Library not loaded");return}switch(ce(),e=e||"exact",e){case"exact":var n=2e3,r=Date.now()+n;(function o(){confetti({particleCount:15,spread:70,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]}),Date.now()<r&&(p=requestAnimationFrame(o))})();break;case"record":var a=3*1e3,s=Date.now()+a;(function o(){confetti({particleCount:10,spread:180,origin:{y:.3,x:Math.random()},colors:["#ff0000","#ff7f00","#ffff00","#00ff00","#0000ff","#8b00ff"]}),Date.now()<s&&(p=requestAnimationFrame(o))})();break;case"winner":var t=4*1e3,i=Date.now()+t;(function o(){confetti({particleCount:10,angle:60,spread:55,origin:{x:0},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),confetti({particleCount:10,angle:120,spread:55,origin:{x:1},colors:["#ff2d6a","#00f5ff","#00ff88","#ffdd00"]}),Date.now()<i&&(p=requestAnimationFrame(o))})();break;case"perfect":var d=5*1e3,c=Date.now()+d;b=setInterval(function(){confetti({particleCount:30,spread:100,origin:{y:.6},colors:["#FFD700","#FFA500","#FFEC8B"]})},500),setTimeout(function(){b&&(clearInterval(b),b=null)},d),function o(){confetti({particleCount:7,angle:60,spread:55,origin:{x:0},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),confetti({particleCount:7,angle:120,spread:55,origin:{x:1},colors:["#FFD700","#ff2d6a","#00f5ff","#00ff88"]}),Date.now()<c&&(p=requestAnimationFrame(o))}();break;default:console.warn("[Dashboard Confetti] Unknown type:",e)}}}function ce(){p&&(cancelAnimationFrame(p),p=null),b&&(clearInterval(b),b=null),typeof confetti!="undefined"&&confetti.reset&&confetti.reset()}function de(e,n){var r=document.getElementById("reaction-container");if(r){var a=document.createElement("div");a.className="reaction-bubble",a.textContent=e+" "+n,a.style.left=20+Math.random()*60+"%",r.appendChild(a),setTimeout(function(){a.remove()},3e3)}}function N(){return M(this,null,function*(){console.log("[Dashboard] Initializing...");var e=yield O();e?(yield BeatifyI18n.init(),BeatifyI18n.initPageTranslations()):console.error("[Dashboard] BeatifyI18n module failed to load - UI will use fallback text"),A()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",N):N(),"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/beatify/static/sw.js",{scope:"/beatify/"}).then(function(e){console.log("[Dashboard] SW registered:",e.scope)}).catch(function(e){console.warn("[Dashboard] SW registration failed:",e)})})})();})();
//# sourceMappingURL=dashboard.min.js.map

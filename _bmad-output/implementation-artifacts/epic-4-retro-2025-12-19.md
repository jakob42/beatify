# Epic 4 Retrospective: Core Gameplay Loop

**Date:** 2025-12-19
**Facilitator:** Bob (Scrum Master)
**Participants:** Alice (PO), Charlie (Senior Dev), Dana (QA), Elena (Junior Dev), Markusholzhaeuser (Project Lead)

---

## Epic Summary

| Metric | Value |
|--------|-------|
| Stories Planned | 6 |
| Stories Completed | 6 (100%) |
| Test Count Growth | 102 → 193 (+91 tests, 89% increase) |
| New Modules Created | 3 (scoring.py, PlaylistManager, MediaPlayerService) |
| FRs Delivered | FR22-FR32 (11 total) |
| Blockers Encountered | 0 |
| Production Incidents | 0 |

### Stories Delivered

1. **Story 4-1: Song Playback via Media Player** - MediaPlayerService, PlaylistManager, round tracking, start_round()
2. **Story 4-2: Round Display (Album Cover & Timer)** - Game view UI, countdown timer, color transitions
3. **Story 4-3: Year Selector & Guess Submission** - Year slider, submission handling, validation
4. **Story 4-4: Submission Tracking Display** - Player indicators, all_submitted() detection
5. **Story 4-5: Timer Expiry & Auto-Advance** - Async timer task, end_round(), phase transitions
6. **Story 4-6: Reveal & Scoring** - scoring.py, reveal UI, personal results, next round flow

---

## What Went Well

### 100% Story Completion
All 6 stories completed with no scope creep and no cut features. Clean sprint execution.

### Exceptional Test Growth
Test count grew from 102 to 193 tests (89% increase). Every story added meaningful unit tests:
- Story 4-1: +36 tests (PlaylistManager, MediaPlayerService, start_round)
- Story 4-3: +14 tests (submission handling)
- Story 4-4: +5 tests (all_submitted logic)
- Story 4-5: +20 tests (timer expiry)
- Story 4-6: +25 tests (scoring calculations)

### Modular Architecture
Created well-isolated modules designed for extensibility:
- `game/scoring.py` - MVP accuracy scoring, ready for Epic 5 extensions
- `game/playlist.py` - PlaylistManager for song selection and tracking
- `services/media_player.py` - MediaPlayerService for HA integration

### Clean Async Patterns
Established reusable patterns for async operations:
- Timer task with proper CancelledError handling
- round_end_callback for state broadcasting
- Debounce pattern for admin controls

### Story File Quality
Detailed dev notes with code patterns, anti-patterns, and architecture compliance notes enabled smooth implementation.

---

## What Could Be Improved

### E2E Tests Deferred
All 6 stories deferred E2E tests to a separate suite. This accumulated as technical debt with no automated integration proof.

### Documentation Conflicts
Story 4-2 dev notes had conflicting guidance:
- Anti-patterns said "Do NOT use setInterval"
- Dev notes recommended "setInterval for efficient 1-second updates"
This created developer confusion.

### Persisting Lint Issues
2 lint issues in websocket.py (SIM105, SIM102) carried from Epic 2. Reduced from 5 but never fully resolved.

### Preemptive Field Additions
Story 4-3 added fields (`round_score`, `years_off`, `missed_round`) preemptively for Story 4-6, blurring story scope boundaries.

### Missing Epic 3 Retrospective
No retrospective was conducted for Epic 3, creating a gap in learning continuity between Epic 2 and Epic 4.

---

## Previous Retrospective Follow-Through (Epic 2)

| ID | Action | Status | Impact on Epic 4 |
|----|--------|--------|------------------|
| A1 | Fix 6 pre-existing HA import test failures | ⚠️ Partial (6→2) | Lint noise persisted |
| A2 | Establish sprint-status.yaml as source of truth | ✅ Done | Status tracking was clean |
| A3 | Add WebSocket multi-client test infrastructure | ✅ Done | Enabled submission tracking tests |
| A4 | Document WebSocket message protocol | ✅ Done | project-context.md comprehensive |
| A5 | Mark code snippets as "exact" vs "pattern" | ✅ Done | Story clarity improved |
| A6 | Test admin reconnection flow manually | ⏳ Deferred | Appropriate - Epic 7 scope |

**Summary:** 4/6 completed, 1 partial, 1 appropriately deferred.

---

## Lessons Learned

### L1: Modular Design Pays Forward
- **Evidence:** scoring.py created in 4-6 is ready for Epic 5 speed/streak extensions
- **Action:** Continue designing modules with future extensibility in mind

### L2: Deferred Work Accumulates
- **Evidence:** E2E tests deferred 6 times, now significant debt
- **Action:** Establish policy: no "deferred to E2E suite" - tests required for done

### L3: Single Source of Truth for Patterns
- **Evidence:** setInterval vs requestAnimationFrame conflict caused confusion
- **Action:** Update project-context.md with definitive guidance

### L4: Story Scope Discipline
- **Evidence:** Story 4-3 added fields for Story 4-6
- **Action:** Stories include only fields needed for that story's ACs

### L5: Continuous Retrospectives Matter
- **Evidence:** Missing Epic 3 retro created learning gap
- **Action:** Retrospective required after every epic

---

## Action Items

### Process Improvements

| ID | Action | Owner | Priority | Success Criteria |
|----|--------|-------|----------|------------------|
| P1 | Resolve documentation conflicts (setInterval vs rAF) | Bob | MEDIUM | Single clear guidance in project-context.md |
| P2 | Establish E2E test policy (no more "deferred") | Bob | HIGH | E2E required before story marked done |
| P3 | Define story scope boundaries more strictly | Bob | MEDIUM | No preemptive field additions |

### Technical Debt

| ID | Action | Owner | Priority | Effort |
|----|--------|-------|----------|--------|
| T1 | Fix SIM105, SIM102 lint issues in websocket.py | Charlie | HIGH | ~15 min |
| T2 | Implement E2E test suite for Epic 4 gameplay | Dana | HIGH | Parallel with 5-1/5-2 |

### Documentation

| ID | Action | Owner | Deadline |
|----|--------|-------|----------|
| D1 | Document betting mechanic for Story 5-3 | Alice | Before 5-3 starts |
| D2 | Update timer implementation guidance | Charlie | Before Epic 5 |

### Team Agreements

- ✓ E2E tests will not be deferred going forward
- ✓ Story scope includes only fields needed for that story
- ✓ Lint issues addressed within same epic they're introduced

---

## Epic 5 Preparation

### Dependencies Met
- [x] scoring.py exists and is extensible
- [x] submission_time tracked (needed for speed bonus)
- [x] streak field tracked on PlayerSession
- [x] Reveal flow established with round_score display
- [x] get_reveal_players_state() sorts by score

### Critical Path (Before Epic 5)

| Task | Owner | Est | Status |
|------|-------|-----|--------|
| Fix 2 lint issues in websocket.py | Charlie | 15 min | Pending |

### Parallel Preparation (During Stories 5-1/5-2)

| Task | Owner | Status |
|------|-------|--------|
| Set up Playwright E2E infrastructure | Dana | Pending |
| Create E2E tests for Epic 4 gameplay | Dana | Pending |
| Document betting mechanic | Alice | Pending |

### Ready Gate for Story 5-3

- [ ] E2E suite running and passing
- [ ] Betting mechanic documented

### Verdict: READY TO START

Epic 5 can begin with Stories 5-1 (speed bonus) and 5-2 (streak tracking) while E2E infrastructure is set up in parallel. Story 5-3 (betting) should not start until E2E suite is ready.

---

## Significant Discoveries

**None requiring epic changes.** The scoring module was designed for extension, and all Epic 4 dependencies for Epic 5 are in place. No architectural assumptions were proven wrong.

---

## Team Health Check

| Dimension | Rating | Notes |
|-----------|--------|-------|
| Collaboration | Strong | Clean handoffs between stories |
| Psychological Safety | Strong | Open discussion of challenges |
| Workload Balance | Good | No burnout indicators |
| Technical Confidence | Strong | Team trusts the architecture |
| Process Maturity | Improving | Second formal retrospective |

---

## Final Summary

Epic 4 delivered the complete core gameplay loop with exceptional quality metrics:
- 100% story completion
- 89% test growth
- 0 blockers, 0 incidents
- Clean modular architecture

The primary gap is E2E test coverage, which will be addressed in parallel with Epic 5's early stories. The team is well-positioned for Epic 5 success.

---

*Generated by BMAD Retrospective Workflow*
*Facilitator: Bob (Scrum Master)*
